groups:
- name: trading-alerts
  rules:
  - alert: AutopilotOrderBurst
    expr: trading:orders_rate_1m > 10
    for: 30m
    labels: {severity: warn}
    annotations:
      summary: Order burst
      description: "Orders >10/s for 30m (rate={{ $value }})"

  - alert: DailyLossBreaker
    expr: trading:pnl_realized_usd < (-0.005 * trading:equity_usd)
    for: 30m
    labels: {severity: page}
    annotations:
      summary: Daily loss breaker
      description: "PnL {{ $value }} < -0.5% equity"

  - alert: ExposureLimitNear
    expr: trading:exposure_usd > 0.9 * on() max_notional_usdt
    for: 30m
    labels: {severity: warn}
    annotations:
      summary: Exposure nearing limit
      description: "Exposure {{ $value }} vs max"

  - alert: EngineDown
    expr: up{job=~"engine_.*"} == 0
    for: 30s
    labels: {severity: page}
    annotations:
      summary: "Engine {{ $labels.job }} down"
      description: "Target not scraping for 30s (demo tolerant)"

  - alert: ReconcileLag
    expr: reconcile_lag_seconds > 60
    for: 2m
    labels: {severity: page}
    annotations: {summary: "Reconcile lag > 60s", runbook: "docs/runbooks/reconcile.md"}

  - alert: OrdersRejectRatioHigh
    expr: sum(rate(orders_rejected_total[5m])) / clamp_min(sum(rate(orders_submitted_total[5m])),1) > 0.2
    for: 5m
    labels: {severity: warn}
    annotations: {summary: "High reject ratio (>20%/5m)"}

  - alert: EquityDropFast
    expr: (max_over_time(trading:equity_usd[10m]) - last_over_time(trading:equity_usd[1m])) / clamp_min(max_over_time(trading:equity_usd[10m]),1) > 0.05
    for: 2m
    labels: {severity: page}
    annotations: {summary: "Equity down >5% in 10m"}

  - alert: StrategyLeverageMismatch
    expr: strategy_leverage_mismatch_total > 0
    for: 5m
    labels: {severity: warn}
    annotations:
      summary: "Leverage configuration mismatch detected"
      description: "{{ $value }} leverage mismatches in stabilization period"
      runbook: "ops/run_stabilization_checks.py"

  - alert: StrategyBucketUsageCritical
    expr: strategy_bucket_usage_fraction > 0.98
    for: 10m
    labels: {severity: critical}
    annotations:
      summary: "Critical bucket usage detected"
      description: "Bucket {{ $labels.bucket }} usage at {{ $value | humanizePercentage }} (>98%)"
      runbook: "ops/run_stabilization_checks.py"

  - alert: StabilizationJobFailed
    expr: stabilization_job_exit_code != 0
    for: 5m
    labels: {severity: page}
    annotations:
      summary: "Stabilization soak failed"
      description: "Nightly stabilization check failed - investigate before deployment"
      runbook: "ops/run_stabilization_checks.py"
