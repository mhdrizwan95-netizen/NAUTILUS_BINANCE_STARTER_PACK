groups:
- name: trading-core
  interval: 15s
  rules:
  - record: trading:orders_rate_1m
    expr: sum by (venue) (increase(orders_submitted_total[1m]))

  - record: trading:fills_rate_1m
    expr: sum by (venue) (increase(orders_filled_total[1m]))

  - record: trading:submit_latency_p95_ms
    expr: histogram_quantile(0.95, sum by (le, job) (rate(submit_to_ack_ms_bucket[5m])))
  - record: trading:fill_latency_p95_ms
    expr: histogram_quantile(0.95, sum by (le, job) (rate(fill_latency_ms_bucket[5m])))

  - record: trading:mark_price_usd
    expr: max by (symbol, venue) (mark_price_usd)

  - record: trading:exposure_usd
    expr: sum by (job, venue) (last_over_time(exposure_usd[2m]))
  - record: trading:pnl_realized_usd
    expr: sum(pnl_realized_total)
  - record: trading:equity_usd
    expr: sum by (job, venue) (last_over_time(equity_usd[2m]))

  - record: trading:upnl_usd
    expr: sum by (venue) (last_over_time(upnl_usd[2m]))

  - record: trading:error_rate_pct
    expr: 100 * sum by (venue) (rate(engine_venue_errors_total[5m])) / clamp_min(sum by (venue) (rate(orders_submitted_total[5m])), 1)

- name: event-modules
  interval: 30s
  rules:
  - alert: MarginLevelLow
    expr: margin_level > 0 and margin_level < 1.15
    for: 45s
    labels:
      severity: warning
      venue: binance
    annotations:
      summary: "Cross-margin level degrading"
      description: "Margin level {{ $value | humanize }} < 1.15"

  - alert: MarginLevelCritical
    expr: margin_level > 0 and margin_level < 1.05
    for: 30s
    labels:
      severity: critical
      venue: binance
    annotations:
      summary: "Cross-margin level below safety floor"
      description: "Margin level {{ $value | humanize }} < 1.05"

  - alert: MarginLiabilityHigh
    expr: margin_liability_usd > 20000
    for: 5m
    labels:
      severity: warning
      venue: binance
    annotations:
      summary: "Cross-margin liabilities elevated"
      description: "Liability {{ $value | humanize }} USD > 20k"

  - alert: ExternalFeedStale
    expr: (time() - external_feed_last_event_epoch) > 180
    for: 2m
    labels:
      severity: warning
      team: strategy
    annotations:
      summary: "External feed idle"
      description: "{{ $labels.source }} feed has been idle for {{ $value | humanizeDuration }}"

  - alert: PromoOrderBudgetSpike
    expr: increase(airdrop_promo_orders_total{status="submitted"}[15m]) > 3
    for: 1m
    labels:
      severity: warning
      team: strategy
    annotations:
      summary: "Airdrop promo orders burst"
      description: ">3 promo orders submitted within 15m"
