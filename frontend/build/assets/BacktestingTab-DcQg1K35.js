import{c as te,r,j as e,b as je,P as ae,h as fe,F as B,p as ve,K as p,Z as be,C as v,B as y,H as Ne,_ as ye,J as Se}from"./index-Rk7jxlAW.js";import{I as F}from"./input-DrLZrDxf.js";import{L as S}from"./label-Duf-LRMe.js";import{P as K,a as G,F as we,b as X,d as Ce,C as Pe,c as ke,E as Re,e as Ie,R as De}from"./ReturnsHistogram-DyPhuCt1.js";import{S as $e,a as Ee,b as Le,c as Te,d as Be,D as Fe}from"./DynamicParamForm-DUZG5EXW.js";import{B as Q}from"./badge-DbHrsCMU.js";import{T as Oe,a as Ae,b as W,c as w,d as Me,e as C}from"./table--BgB20oK.js";import{D as Z}from"./download-CQ9v00CE.js";import"./LineChart-CsN3wN5o.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],_e=te("loader-circle",Ue);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],qe=te("rotate-ccw",Ve);var O="Progress",A=100,[Je]=je(O),[ze,He]=Je(O),re=r.forwardRef((t,a)=>{const{__scopeProgress:c,value:x=null,max:n,getValueLabel:g=Ke,...d}=t;(n||n===0)&&!Y(n)&&console.error(Ge(`${n}`,"Progress"));const m=Y(n)?n:A;x!==null&&!ee(x,m)&&console.error(Xe(`${x}`,"Progress"));const o=ee(x,m)?x:null,b=D(o)?g(o,m):void 0;return e.jsx(ze,{scope:c,value:o,max:m,children:e.jsx(ae.div,{"aria-valuemax":m,"aria-valuemin":0,"aria-valuenow":D(o)?o:void 0,"aria-valuetext":b,role:"progressbar","data-state":ie(o,m),"data-value":o??void 0,"data-max":m,...d,ref:a})})});re.displayName=O;var ne="ProgressIndicator",le=r.forwardRef((t,a)=>{const{__scopeProgress:c,...x}=t,n=He(ne,c);return e.jsx(ae.div,{"data-state":ie(n.value,n.max),"data-value":n.value??void 0,"data-max":n.max,...x,ref:a})});le.displayName=ne;function Ke(t,a){return`${Math.round(t/a*100)}%`}function ie(t,a){return t==null?"indeterminate":t===a?"complete":"loading"}function D(t){return typeof t=="number"}function Y(t){return D(t)&&!isNaN(t)&&t>0}function ee(t,a){return D(t)&&!isNaN(t)&&t<=a&&t>=0}function Ge(t,a){return`Invalid prop \`max\` of value \`${t}\` supplied to \`${a}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${A}\`.`}function Xe(t,a){return`Invalid prop \`value\` of value \`${t}\` supplied to \`${a}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${A} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var Qe=re,We=le;function Ze({className:t,value:a,...c}){return e.jsx(Qe,{"data-slot":"progress",className:fe("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",t),...c,children:e.jsx(We,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:`translateX(-${100-(a||0)}%)`}})})}function Ye(t,a,c=!0){const[x,n]=r.useState(null),[g,d]=r.useState(null),m=r.useRef(null);return r.useEffect(()=>{if(!c)return;let o=!1;const b=async()=>{try{const j=await t();o||n(j)}catch(j){!o&&j instanceof Error&&d(j)}finally{o||(m.current=window.setTimeout(b,a))}};return b(),()=>{o=!0,m.current&&window.clearTimeout(m.current)}},[t,a,c]),{data:x,error:g}}const es=()=>{const t=new Date,a=new Date;return a.setMonth(a.getMonth()-1),{from:a,to:t}};function se(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}).format(t)}function ds(){const[t,a]=r.useState([]),[c,x]=r.useState(""),[n,g]=r.useState([]),[d,m]=r.useState(()=>es()),[o,b]=r.useState(1e4),[j,oe]=r.useState(5),[M,ce]=r.useState(2),[de,R]=r.useState({}),[f,I]=r.useState(null),[N,$]=r.useState(null),[E,U]=r.useState(!1),_=B(s=>s.opsAuth.token),me=B(s=>s.opsAuth.actor),V=B(s=>s.opsAuth.approver),l=r.useMemo(()=>t.find(s=>s.id===c)??null,[t,c]);r.useEffect(()=>{const s=new AbortController;return ve(s.signal).then(i=>{a(i),!c&&i.length&&(x(i[0].id),g(i[0].symbols),R(i[0].params??{}))}).catch(i=>{!s.signal.aborted&&i instanceof Error&&p.error("Unable to load strategies",{description:i.message})}),()=>s.abort()},[]),r.useEffect(()=>{l&&(g(l.symbols),R(l.params??{}))},[l]);const ue=r.useCallback(()=>f?be(f):Promise.resolve(null),[f]),{data:P}=Ye(ue,1200,!!f);r.useEffect(()=>{P&&($(P),P.status==="done"?(p.success("Backtest completed",{description:"Results ready below"}),I(null)):P.status==="error"&&(p.error("Backtest failed"),I(null)))},[P]);const q=r.useMemo(()=>{const s=new Set;return t.forEach(i=>i.symbols.forEach(k=>s.add(k))),Array.from(s).sort()},[t]),u=N?.result,xe=async()=>{if(!_.trim()){p.error("Provide an OPS API token before launching a backtest");return}if(!V.trim()){p.error("Provide an approver token before launching a backtest");return}if(!l){p.error("Select a strategy");return}if(!d?.from||!d?.to){p.error("Select a date range");return}U(!0);try{const s=await ye({strategyId:l.id,params:de,symbols:n,startDate:d.from.toISOString(),endDate:d.to.toISOString(),initialCapital:o,feeBps:j,slippageBps:M},{token:_.trim(),actor:me.trim()||void 0,approverToken:V.trim()||void 0,idempotencyKey:Se(`backtest-${l.id}`)});I(s.jobId),$(null),p("Backtest started",{description:`Job ${s.jobId}`})}catch(s){s instanceof Error&&p.error("Unable to start backtest",{description:s.message})}finally{U(!1)}},pe=s=>{g(i=>i.includes(s)?i.filter(k=>k!==s):[...i,s])},J=s=>{if(!u)return;if(s==="json"){const h=new Blob([JSON.stringify(u,null,2)],{type:"application/json"}),H=URL.createObjectURL(h),T=document.createElement("a");T.href=H,T.download=`backtest-${l?.name??"result"}.json`,T.click(),URL.revokeObjectURL(H);return}const i=u.trades??[],k="time,symbol,side,qty,price,pnl",he=i.map(h=>[h.time,h.symbol,h.side,h.qty,h.price,h.pnl??""].join(",")),ge=new Blob([`${k}
${he.join(`
`)}`],{type:"text/csv"}),z=URL.createObjectURL(ge),L=document.createElement("a");L.href=z,L.download=`backtest-${l?.name??"trades"}.csv`,L.click(),URL.revokeObjectURL(z)};return e.jsx("div",{className:"space-y-6 p-6",children:e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs(v,{className:"space-y-4 p-4 lg:col-span-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Strategy"}),e.jsxs($e,{value:c,onValueChange:x,children:[e.jsx(Ee,{children:e.jsx(Le,{placeholder:"Select a strategy"})}),e.jsx(Te,{children:t.map(s=>e.jsx(Be,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Symbols"}),e.jsxs(K,{children:[e.jsx(G,{asChild:!0,children:e.jsxs(y,{variant:"outline",size:"sm",className:"flex w-full items-center justify-start gap-2",children:[e.jsx(we,{className:"h-4 w-4"}),n.length?`${n.length} selected`:"All symbols"]})}),e.jsx(X,{className:"w-60 p-0",align:"start",children:e.jsxs("div",{className:"max-h-64 space-y-2 overflow-y-auto p-3",children:[q.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Ce,{checked:n.includes(s),onCheckedChange:()=>pe(s)}),e.jsx("span",{children:s})]},s)),q.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"No symbols available"})]})})]}),e.jsx("div",{className:"flex flex-wrap gap-1 text-xs text-muted-foreground",children:n.map(s=>e.jsx(Q,{variant:"outline",children:s},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Date Range"}),e.jsxs(K,{children:[e.jsx(G,{asChild:!0,children:e.jsxs(y,{variant:"outline",size:"sm",className:"flex w-full items-center justify-start gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),d?.from&&d?.to?`${d.from.toLocaleDateString()} – ${d.to.toLocaleDateString()}`:"Select range"]})}),e.jsx(X,{align:"start",className:"p-0",children:e.jsx(ke,{mode:"range",selected:d,onSelect:m,numberOfMonths:2,initialFocus:!0})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Initial Capital"}),e.jsx(F,{type:"number",value:o,onChange:s=>b(Number(s.target.value)||0),min:0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Fee (bps)"}),e.jsx(F,{type:"number",value:j,onChange:s=>oe(Number(s.target.value)||0),min:0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Slippage (bps)"}),e.jsx(F,{type:"number",value:M,onChange:s=>ce(Number(s.target.value)||0),min:0})]})]}),l&&e.jsxs("div",{className:"rounded-lg border border-border p-3",children:[e.jsx("h4",{className:"mb-2 text-sm font-medium",children:"Parameters"}),e.jsx(Fe,{schema:l.paramsSchema,initial:l.params,submitLabel:"Apply Overrides",onChange:R,onSubmit:s=>{R(s),p("Overrides saved")}},l.id)]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsxs(y,{className:"flex-1",onClick:xe,disabled:E||!l,children:[E?e.jsx(_e,{className:"h-4 w-4 animate-spin"}):e.jsx(Ne,{className:"h-4 w-4"}),e.jsx("span",{children:E?"Starting…":"Run Backtest"})]}),e.jsx(y,{variant:"outline",size:"icon",onClick:()=>{$(null),I(null)},children:e.jsx(qe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-4 lg:col-span-2",children:[e.jsxs(v,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Status"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:N?.status?N.status.toUpperCase():f?"Polling…":"Idle"})]}),N?.progress!==void 0&&e.jsxs(Q,{variant:"outline",children:[Math.round(N.progress*100),"%"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(Ze,{value:(N?.progress??0)*100})}),f&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Job: ",f]})]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs(v,{className:"p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("h3",{className:"font-medium",children:"Summary"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>J("csv"),children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Trades CSV"]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>J("json"),children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Full JSON"]})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 text-sm md:grid-cols-5",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Return"}),e.jsxs("p",{children:[(u.metrics.totalReturn*100).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Sharpe"}),e.jsx("p",{children:u.metrics.sharpe.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Max Drawdown"}),e.jsxs("p",{children:[(u.metrics.maxDrawdown*100).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),e.jsxs("p",{children:[(u.metrics.winRate*100).toFixed(1),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Trades"}),e.jsx("p",{children:u.metrics.trades})]})]})]}),e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"Equity Curve"}),e.jsx(Re,{data:u.equityCurve.map(s=>({t:s.t,[l?.name??"Strategy"]:s.equity})),series:[{key:l?.name??"Strategy",label:l?.name??"Strategy"}]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"PnL by Symbol"}),e.jsx(Ie,{data:u.pnlBySymbol})]}),e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"Distribution of Returns"}),e.jsx(De,{returns:u.returns})]})]}),e.jsxs(v,{className:"p-4",children:[e.jsx("h3",{className:"mb-3 font-medium",children:"Trades"}),e.jsxs(Oe,{children:[e.jsx(Ae,{children:e.jsxs(W,{children:[e.jsx(w,{children:"Time"}),e.jsx(w,{children:"Symbol"}),e.jsx(w,{children:"Side"}),e.jsx(w,{children:"Qty"}),e.jsx(w,{children:"Price"}),e.jsx(w,{className:"text-right",children:"PnL"})]})}),e.jsx(Me,{children:(u.trades??[]).map(s=>e.jsxs(W,{children:[e.jsx(C,{children:new Date(s.time).toLocaleString()}),e.jsx(C,{children:s.symbol}),e.jsx(C,{className:s.side==="buy"?"text-emerald-400":"text-red-400",children:s.side.toUpperCase()}),e.jsx(C,{children:s.qty}),e.jsx(C,{children:se(s.price)}),e.jsx(C,{className:"text-right",children:s.pnl!==void 0?se(s.pnl):"—"})]},`${s.time}-${s.symbol}-${s.price}`))})]})]})]})]})]})})}export{ds as BacktestingTab};
//# sourceMappingURL=BacktestingTab-DcQg1K35.js.map
