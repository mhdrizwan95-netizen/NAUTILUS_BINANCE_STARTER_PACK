import{a4 as P,a5 as B,a6 as E,a7 as D,a8 as _,a9 as A,r as c,aa as I,ab as M,c as K,j as e,h as F,m as U,C as x,J as f,K as g,L as v,B as b,ac as J,M as y,S as N,G as u,q as w,ad as H,ae as q}from"./index-DWw6XOll.js";import{B as G}from"./badge-BdbezaWL.js";import{I as Q}from"./input-BbM6-wEd.js";import{L as V}from"./label-Dg3l06KM.js";import{v as k,f as R}from"./validation-COF01_rP.js";import{D as Y}from"./download-Bfvn9BPe.js";var $=class extends P{#t;#r=void 0;#e;#s;constructor(s,r){super(),this.#t=s,this.setOptions(r),this.bindMethods(),this.#i()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(s){const r=this.options;this.options=this.#t.defaultMutationOptions(s),B(this.options,r)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#e,observer:this}),r?.mutationKey&&this.options.mutationKey&&E(r.mutationKey)!==E(this.options.mutationKey)?this.reset():this.#e?.state.status==="pending"&&this.#e.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#e?.removeObserver(this)}onMutationUpdate(s){this.#i(),this.#n(s)}getCurrentResult(){return this.#r}reset(){this.#e?.removeObserver(this),this.#e=void 0,this.#i(),this.#n()}mutate(s,r){return this.#s=r,this.#e?.removeObserver(this),this.#e=this.#t.getMutationCache().build(this.#t,this.options),this.#e.addObserver(this),this.#e.execute(s)}#i(){const s=this.#e?.state??D();this.#r={...s,isPending:s.status==="pending",isSuccess:s.status==="success",isError:s.status==="error",isIdle:s.status==="idle",mutate:this.mutate,reset:this.reset}}#n(s){_.batch(()=>{if(this.#s&&this.hasListeners()){const r=this.#r.variables,l=this.#r.context,n={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};s?.type==="success"?(this.#s.onSuccess?.(s.data,r,l,n),this.#s.onSettled?.(s.data,null,r,l,n)):s?.type==="error"&&(this.#s.onError?.(s.error,r,l,n),this.#s.onSettled?.(void 0,s.error,r,l,n))}this.listeners.forEach(r=>{r(this.#r)})})}};function W(s,r){const l=A(),[n]=c.useState(()=>new $(l,s));c.useEffect(()=>{n.setOptions(s)},[n,s]);const d=c.useSyncExternalStore(c.useCallback(h=>n.subscribe(_.batchCalls(h)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),m=c.useCallback((h,i)=>{n.mutate(h,i).catch(I)},[n]);if(d.error&&M(n.options.throwOnError,[d.error]))throw d.error;return{...d,mutate:m,mutateAsync:d.mutate}}/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Z=K("copy",X);function ee({className:s,...r}){return e.jsx("textarea",{"data-slot":"textarea",className:F("resize-none border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-input-background px-3 py-2 text-base transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),...r})}const te=[{key:"DRY_RUN",label:"Dry Run",description:"Route execution in simulation mode without placing real orders."},{key:"SYMBOL_SCANNER_ENABLED",label:"Symbol Scanner",description:"Continuously refresh the universe scanner feed."},{key:"SOFT_BREACH_ENABLED",label:"Soft Breach Guard",description:"Alerts and guard-rail for risk rails before hard stops trigger."},{key:"SOFT_BREACH_BREAKEVEN_OK",label:"Breakeven Allowed",description:"Permit breakeven exits when a soft breach fires."},{key:"SOFT_BREACH_CANCEL_ENTRIES",label:"Cancel Entries",description:"Cancel outstanding entry orders when a soft breach triggers."}];function ce(){const s=A(),[r,l]=c.useState(""),[n,d]=c.useState("{}"),[m,h]=c.useState(!1),i=U({queryKey:w.settings.config(),queryFn:()=>q().then(t=>k(R,t,"Runtime config")),refetchInterval:6e4});c.useEffect(()=>{!i.data||m||d(JSON.stringify(i.data.overrides??{},null,2))},[i.data,m]);const O=c.useMemo(()=>{const t=i.data?.effective?.SOFT_BREACH_TIGHTEN_SL_PCT??i.data?.overrides?.SOFT_BREACH_TIGHTEN_SL_PCT;return typeof t=="number"?t:null},[i.data]),j=W({mutationFn:async({patch:t,token:o})=>{const a=await H(t,o);return k(R,a,"Updated runtime config")},onSuccess:t=>{u.success("Runtime configuration updated"),h(!1),d(JSON.stringify(t.overrides??{},null,2)),s.setQueryData(w.settings.config(),t)},onError:t=>{u.error("Failed to update configuration",{description:t instanceof Error?t.message:"Unknown error occurred"})}}),S=c.useMemo(()=>{try{const t=JSON.parse(n||"{}");return!(t&&typeof t=="object"&&!Array.isArray(t))}catch{return!0}},[n]),T=()=>{if(!r.trim()){u.error("Provide an OPS API token to update configuration");return}let t;try{t=JSON.parse(n||"{}")}catch(o){u.error("Overrides JSON is invalid",{description:o instanceof Error?o.message:void 0});return}if(!t||typeof t!="object"||Array.isArray(t)){u.error("Overrides must be a JSON object");return}j.mutate({patch:t,token:r.trim()})},L=async(t,o)=>{try{await navigator.clipboard.writeText(JSON.stringify(t,null,2)),u.success(`${o} copied to clipboard`)}catch(a){u.error(`Unable to copy ${o}`,{description:a instanceof Error?a.message:void 0})}},z=(t,o)=>{try{const a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),C=URL.createObjectURL(a),p=document.createElement("a");p.href=C,p.download=o,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(C)}catch(a){u.error("Download failed",{description:a instanceof Error?a.message:void 0})}};return e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs(x,{children:[e.jsxs(f,{className:"flex flex-row items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{children:"OPS API Token"}),e.jsx(v,{children:"Provide the bearer token required by the Ops API. The value stays in memory only."})]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>i.refetch(),disabled:i.isRefetching,children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Refresh config"]})]}),e.jsxs(y,{className:"space-y-3",children:[e.jsx(V,{htmlFor:"ops-token",children:"X-Ops-Token header"}),e.jsx(Q,{id:"ops-token",type:"password",value:r,onChange:t=>l(t.target.value),placeholder:"Paste OPS_API_TOKEN value",autoComplete:"off"}),e.jsxs("p",{className:"text-xs text-zinc-500",children:["When running locally, export ",e.jsx("code",{children:"OPS_API_TOKEN"})," or ",e.jsx("code",{children:"OPS_API_TOKEN_FILE"})," and reuse that value here for authenticated updates."]})]})]}),e.jsxs(x,{children:[e.jsxs(f,{className:"flex flex-row items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{children:"Protection & Automation Flags"}),e.jsxs(v,{children:["Values reflect ",e.jsx("code",{children:"config/runtime.yaml"})," merged with overrides."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>L(i.data?.overrides??{},"Overrides JSON"),disabled:i.isLoading,children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Copy overrides"]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>z(i.data?.effective??{},"runtime-config.json"),disabled:i.isLoading,children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Download config"]})]})]}),e.jsxs(y,{children:[i.isLoading?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:Array.from({length:5}).map((t,o)=>e.jsx(N,{className:"h-24 rounded-xl"},o))}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:te.map(t=>{const a=(i.data?.effective?.[t.key]??i.data?.overrides?.[t.key])===!0;return e.jsxs("div",{className:"rounded-xl border border-zinc-800/60 bg-zinc-900/40 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx("p",{className:"text-sm font-medium text-zinc-200",children:t.label}),e.jsx(G,{variant:a?"secondary":"outline",className:a?"bg-emerald-500/10 text-emerald-300":"",children:a?"ENABLED":"DISABLED"})]}),e.jsx("p",{className:"text-xs text-zinc-500",children:t.description})]},t.key)})}),e.jsxs("div",{className:"mt-6 rounded-xl border border-zinc-800/60 bg-zinc-900/40 p-4",children:[e.jsx("p",{className:"text-sm font-medium text-zinc-200",children:"Soft Breach tighten stop-loss"}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Percentage applied to tighten the stop-loss when a soft breach occurs."}),e.jsx("div",{className:"mt-3 text-lg font-semibold text-zinc-100",children:O!==null?`${(O*100).toFixed(1)}%`:"—"})]})]})]}),e.jsxs(x,{children:[e.jsxs(f,{className:"flex flex-row items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{children:"Runtime Overrides"}),e.jsxs(v,{children:["Edit the JSON payload sent to ",e.jsx("code",{children:"PUT /api/config"}),"."]})]}),e.jsx(b,{variant:"secondary",size:"sm",onClick:T,disabled:j.isPending||S||!m,children:j.isPending?"Saving…":"Save overrides"})]}),e.jsx(y,{children:i.isLoading?e.jsx(N,{className:"h-48 w-full"}):e.jsxs("div",{className:"rounded-lg border border-zinc-800/60 bg-zinc-950/40 p-4 space-y-3",children:[e.jsx(ee,{value:n,onChange:t=>{d(t.target.value),h(!0)},className:"h-64 font-mono text-xs"}),e.jsxs("p",{className:"text-xs text-zinc-500",children:["Example: ",e.jsx("code",{children:'{"DRY_RUN": false, "SOFT_BREACH_ENABLED": true}'})]}),S&&e.jsx("p",{className:"text-xs text-amber-400",children:"Overrides must be valid JSON representing an object."})]})})]}),e.jsxs(x,{children:[e.jsxs(f,{children:[e.jsx(g,{children:"Effective Configuration"}),e.jsxs(v,{children:["Resulting payload served to clients (",e.jsx("code",{children:"config/runtime.yaml"})," merged with overrides)."]})]}),e.jsx(y,{children:i.isLoading?e.jsx(N,{className:"h-64 w-full"}):e.jsx("div",{className:"rounded-lg border border-zinc-800/60 bg-zinc-950/40 p-4",children:e.jsx("pre",{className:"max-h-80 overflow-auto text-xs leading-6 text-zinc-300",children:JSON.stringify(i.data?.effective??{},null,2)})})})]}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Updates apply immediately and are persisted by the Ops service. Keep your token secure; the Command Center never stores it beyond this session."})]})}export{ce as SettingsTab};
