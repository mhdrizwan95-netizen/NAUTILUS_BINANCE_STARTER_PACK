import{c as M,j as r,o as e,q as xe,P as ee,z as he,I as p,C as v,B as N}from"./index-DTayauxn.js";import{S as pe,a as ge,b as je,c as fe,d as ve,I as T}from"./select-BIy1EetY.js";import{L as S}from"./index-Czg2m92V.js";import{P as J,a as H,F as be,b as G,d as ye,C as Ne,c as Se,E as we,e as Ce,R as Pe,T as Re,f as ke,g as X,h as w,i as Ie,j as C}from"./ReturnsHistogram-DThSGTvG.js";import{g as $e,p as De,B as Q,i as Ee}from"./api-CNNmOJT6.js";import{D as Le,P as Be}from"./DynamicParamForm-CW-V2QC6.js";import"./generateCategoricalChart-xSD5sOcd.js";import"./BarChart-Drf8rBtt.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]],W=M("download",Te);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Fe=M("loader-circle",Me);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ue=M("rotate-ccw",Oe);var F="Progress",O=100,[_e]=xe(F),[qe,Ae]=_e(F),se=r.forwardRef((t,a)=>{const{__scopeProgress:c,value:x=null,max:n,getValueLabel:g=Ve,...d}=t;(n||n===0)&&!K(n)&&console.error(ze(`${n}`,"Progress"));const m=K(n)?n:O;x!==null&&!Y(x,m)&&console.error(Je(`${x}`,"Progress"));const o=Y(x,m)?x:null,b=$(o)?g(o,m):void 0;return e.jsx(qe,{scope:c,value:o,max:m,children:e.jsx(ee.div,{"aria-valuemax":m,"aria-valuemin":0,"aria-valuenow":$(o)?o:void 0,"aria-valuetext":b,role:"progressbar","data-state":re(o,m),"data-value":o??void 0,"data-max":m,...d,ref:a})})});se.displayName=F;var te="ProgressIndicator",ae=r.forwardRef((t,a)=>{const{__scopeProgress:c,...x}=t,n=Ae(te,c);return e.jsx(ee.div,{"data-state":re(n.value,n.max),"data-value":n.value??void 0,"data-max":n.max,...x,ref:a})});ae.displayName=te;function Ve(t,a){return`${Math.round(t/a*100)}%`}function re(t,a){return t==null?"indeterminate":t===a?"complete":"loading"}function $(t){return typeof t=="number"}function K(t){return $(t)&&!isNaN(t)&&t>0}function Y(t,a){return $(t)&&!isNaN(t)&&t<=a&&t>=0}function ze(t,a){return`Invalid prop \`max\` of value \`${t}\` supplied to \`${a}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${O}\`.`}function Je(t,a){return`Invalid prop \`value\` of value \`${t}\` supplied to \`${a}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${O} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var He=se,Ge=ae;function Xe({className:t,value:a,...c}){return e.jsx(He,{"data-slot":"progress",className:he("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",t),...c,children:e.jsx(Ge,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:`translateX(-${100-(a||0)}%)`}})})}function Qe(t,a,c=!0){const[x,n]=r.useState(null),[g,d]=r.useState(null),m=r.useRef(null);return r.useEffect(()=>{if(!c)return;let o=!1;const b=async()=>{try{const j=await t();o||n(j)}catch(j){!o&&j instanceof Error&&d(j)}finally{o||(m.current=window.setTimeout(b,a))}};return b(),()=>{o=!0,m.current&&window.clearTimeout(m.current)}},[t,a,c]),{data:x,error:g}}const We=()=>{const t=new Date,a=new Date;return a.setMonth(a.getMonth()-1),{from:a,to:t}};function Z(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}).format(t)}function ns(){const[t,a]=r.useState([]),[c,x]=r.useState(""),[n,g]=r.useState([]),[d,m]=r.useState(()=>We()),[o,b]=r.useState(1e4),[j,ne]=r.useState(5),[U,le]=r.useState(2),[ie,k]=r.useState({}),[f,I]=r.useState(null),[y,D]=r.useState(null),[E,_]=r.useState(!1),l=r.useMemo(()=>t.find(s=>s.id===c)??null,[t,c]);r.useEffect(()=>{const s=new AbortController;return $e(s.signal).then(i=>{a(i),!c&&i.length&&(x(i[0].id),g(i[0].symbols),k(i[0].params??{}))}).catch(i=>{!s.signal.aborted&&i instanceof Error&&p.error("Unable to load strategies",{description:i.message})}),()=>s.abort()},[]),r.useEffect(()=>{l&&(g(l.symbols),k(l.params??{}))},[l]);const oe=r.useCallback(()=>f?De(f):Promise.resolve(null),[f]),{data:P}=Qe(oe,1200,!!f);r.useEffect(()=>{P&&(D(P),P.status==="done"?(p.success("Backtest completed",{description:"Results ready below"}),I(null)):P.status==="error"&&(p.error("Backtest failed"),I(null)))},[P]);const q=r.useMemo(()=>{const s=new Set;return t.forEach(i=>i.symbols.forEach(R=>s.add(R))),Array.from(s).sort()},[t]),u=y?.result,ce=async()=>{if(!l){p.error("Select a strategy");return}if(!d?.from||!d?.to){p.error("Select a date range");return}_(!0);try{const s=await Ee({strategyId:l.id,params:ie,symbols:n,startDate:d.from.toISOString(),endDate:d.to.toISOString(),initialCapital:o,feeBps:j,slippageBps:U});I(s.jobId),D(null),p("Backtest started",{description:`Job ${s.jobId}`})}catch(s){s instanceof Error&&p.error("Unable to start backtest",{description:s.message})}finally{_(!1)}},de=s=>{g(i=>i.includes(s)?i.filter(R=>R!==s):[...i,s])},A=s=>{if(!u)return;if(s==="json"){const h=new Blob([JSON.stringify(u,null,2)],{type:"application/json"}),z=URL.createObjectURL(h),B=document.createElement("a");B.href=z,B.download=`backtest-${l?.name??"result"}.json`,B.click(),URL.revokeObjectURL(z);return}const i=u.trades??[],R="time,symbol,side,qty,price,pnl",me=i.map(h=>[h.time,h.symbol,h.side,h.qty,h.price,h.pnl??""].join(",")),ue=new Blob([`${R}
${me.join(`
`)}`],{type:"text/csv"}),V=URL.createObjectURL(ue),L=document.createElement("a");L.href=V,L.download=`backtest-${l?.name??"trades"}.csv`,L.click(),URL.revokeObjectURL(V)};return e.jsx("div",{className:"space-y-6 p-6",children:e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs(v,{className:"space-y-4 p-4 lg:col-span-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Strategy"}),e.jsxs(pe,{value:c,onValueChange:x,children:[e.jsx(ge,{children:e.jsx(je,{placeholder:"Select a strategy"})}),e.jsx(fe,{children:t.map(s=>e.jsx(ve,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Symbols"}),e.jsxs(J,{children:[e.jsx(H,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"sm",className:"flex w-full items-center justify-start gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),n.length?`${n.length} selected`:"All symbols"]})}),e.jsx(G,{className:"w-60 p-0",align:"start",children:e.jsxs("div",{className:"max-h-64 space-y-2 overflow-y-auto p-3",children:[q.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ye,{checked:n.includes(s),onCheckedChange:()=>de(s)}),e.jsx("span",{children:s})]},s)),q.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"No symbols available"})]})})]}),e.jsx("div",{className:"flex flex-wrap gap-1 text-xs text-muted-foreground",children:n.map(s=>e.jsx(Q,{variant:"outline",children:s},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Date Range"}),e.jsxs(J,{children:[e.jsx(H,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"sm",className:"flex w-full items-center justify-start gap-2",children:[e.jsx(Ne,{className:"h-4 w-4"}),d?.from&&d?.to?`${d.from.toLocaleDateString()} – ${d.to.toLocaleDateString()}`:"Select range"]})}),e.jsx(G,{align:"start",className:"p-0",children:e.jsx(Se,{mode:"range",selected:d,onSelect:m,numberOfMonths:2,initialFocus:!0})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Initial Capital"}),e.jsx(T,{type:"number",value:o,onChange:s=>b(Number(s.target.value)||0),min:0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Fee (bps)"}),e.jsx(T,{type:"number",value:j,onChange:s=>ne(Number(s.target.value)||0),min:0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-xs text-muted-foreground",children:"Slippage (bps)"}),e.jsx(T,{type:"number",value:U,onChange:s=>le(Number(s.target.value)||0),min:0})]})]}),l&&e.jsxs("div",{className:"rounded-lg border border-border p-3",children:[e.jsx("h4",{className:"mb-2 text-sm font-medium",children:"Parameters"}),e.jsx(Le,{schema:l.paramsSchema,initial:l.params,submitLabel:"Apply Overrides",onChange:k,onSubmit:s=>{k(s),p("Overrides saved")}},l.id)]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsxs(N,{className:"flex-1",onClick:ce,disabled:E||!l,children:[E?e.jsx(Fe,{className:"h-4 w-4 animate-spin"}):e.jsx(Be,{className:"h-4 w-4"}),e.jsx("span",{children:E?"Starting…":"Run Backtest"})]}),e.jsx(N,{variant:"outline",size:"icon",onClick:()=>{D(null),I(null)},children:e.jsx(Ue,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-4 lg:col-span-2",children:[e.jsxs(v,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Status"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y?.status?y.status.toUpperCase():f?"Polling…":"Idle"})]}),y?.progress!==void 0&&e.jsxs(Q,{variant:"outline",children:[Math.round(y.progress*100),"%"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(Xe,{value:(y?.progress??0)*100})}),f&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Job: ",f]})]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs(v,{className:"p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("h3",{className:"font-medium",children:"Summary"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>A("csv"),children:[e.jsx(W,{className:"mr-2 h-4 w-4"}),"Trades CSV"]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>A("json"),children:[e.jsx(W,{className:"mr-2 h-4 w-4"}),"Full JSON"]})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 text-sm md:grid-cols-5",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Return"}),e.jsxs("p",{children:[(u.metrics.totalReturn*100).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Sharpe"}),e.jsx("p",{children:u.metrics.sharpe.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Max Drawdown"}),e.jsxs("p",{children:[(u.metrics.maxDrawdown*100).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Win Rate"}),e.jsxs("p",{children:[(u.metrics.winRate*100).toFixed(1),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Trades"}),e.jsx("p",{children:u.metrics.trades})]})]})]}),e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"Equity Curve"}),e.jsx(we,{data:u.equityCurve.map(s=>({t:s.t,[l?.name??"Strategy"]:s.equity})),series:[{key:l?.name??"Strategy",label:l?.name??"Strategy"}]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"PnL by Symbol"}),e.jsx(Ce,{data:u.pnlBySymbol})]}),e.jsxs(v,{className:"space-y-4 p-4",children:[e.jsx("h3",{className:"font-medium",children:"Distribution of Returns"}),e.jsx(Pe,{returns:u.returns})]})]}),e.jsxs(v,{className:"p-4",children:[e.jsx("h3",{className:"mb-3 font-medium",children:"Trades"}),e.jsxs(Re,{children:[e.jsx(ke,{children:e.jsxs(X,{children:[e.jsx(w,{children:"Time"}),e.jsx(w,{children:"Symbol"}),e.jsx(w,{children:"Side"}),e.jsx(w,{children:"Qty"}),e.jsx(w,{children:"Price"}),e.jsx(w,{className:"text-right",children:"PnL"})]})}),e.jsx(Ie,{children:(u.trades??[]).map(s=>e.jsxs(X,{children:[e.jsx(C,{children:new Date(s.time).toLocaleString()}),e.jsx(C,{children:s.symbol}),e.jsx(C,{className:s.side==="buy"?"text-emerald-400":"text-red-400",children:s.side.toUpperCase()}),e.jsx(C,{children:s.qty}),e.jsx(C,{children:Z(s.price)}),e.jsx(C,{className:"text-right",children:s.pnl!==void 0?Z(s.pnl):"—"})]},`${s.time}-${s.symbol}-${s.price}`))})]})]})]})]})]})})}export{ns as BacktestingTab};
