{
  "findings": [
    {
      "id": "ml-registry-not-exactly-once",
      "severity": "S1",
      "area": "ml",
      "file": "services/ml_service/app/config.py",
      "lines": "7-24",
      "evidence": "Training defaults point to /shared/manifest.sqlite with EXACTLY_ONCE=False, so the ML service reuses historical bars and can process the same CSV repeatedly, skewing retraining stats.",
      "impact": "Backtests and live retraining share the same ledger path, causing data leakage between research runs and production retrains, and making it impossible to reason about model lineage.",
      "fix": "Set EXACTLY_ONCE=True by default and add research-specific defaults for LEDGER_DB/DATA_INCOMING (or configurable path separation).",
      "diff": "diff --git a/services/ml_service/app/config.py b/services/ml_service/app/config.py\n@@\n-    EXACTLY_ONCE: bool = (\n-        False  # if true: use only new bars > training watermark (no reuse)\n-    )\n+    EXACTLY_ONCE: bool = True  # process each ingested file once for production retraining\n+    LEDGER_DB: str = Field('/ml/manifest.sqlite')\n+    DATA_DIR: str = Field('/ml/data')"
    },
    {
      "id": "ml-model-metadata-seed",
      "severity": "S2",
      "area": "ml",
      "file": "services/ml_service/app/inference.py",
      "lines": "1-60",
      "evidence": "Active model watcher loads joblib artifacts without verifying metadata or random seeds, so successive retrains may produce non-deterministic models without a seed capture.",
      "impact": "Inability to reproduce a promoted model since training randomness (GaussianHMM, KMeans) depends on hard-coded seeds and metadata lacks RNG state.",
      "fix": "Capture RNG seeds in metadata and allow override via config so retraining can be reproduced.",
      "diff": "(documented patch to add seed capture)"
    }
  ],
  "risk_rollup": {
    "S0": 0,
    "S1": 1,
    "S2": 1,
    "S3": 0
  },
  "tickets": [
    {
      "title": "Isolate ML retraining ledger and capture RNG seeds",
      "owner": "ml",
      "eta": "3d",
      "blocks": [],
      "acceptance": [
        "ML retrains read from /ml/manifest.sqlite and delete-after-process",
        "Model metadata includes training seed and feature version",
        "Backtest suite uses /research manifests"
      ]
    }
  ],
  "state": {
    "slices": [
      {
        "name": "Containers & Orchestration",
        "paths": [
          "docker-compose.yml",
          "Dockerfile",
          "ops/observability",
          "services"
        ]
      },
      {
        "name": "Network & Timeouts",
        "paths": [
          "engine/core",
          "ops",
          "frontend/src/lib"
        ]
      },
      {
        "name": "Config & Secrets",
        "paths": [
          "env.example",
          "config.example.env",
          "ops",
          "engine"
        ]
      },
      {
        "name": "Observability & Metrics",
        "paths": [
          "ops/observability",
          "prometheus",
          "engine/metrics.py",
          "frontend/src/lib/monitoring.ts"
        ]
      },
      {
        "name": "Frontend UI/Analytics",
        "paths": [
          "frontend/src",
          "frontend/package.json",
          "frontend/vitest.config.ts"
        ]
      },
      {
        "name": "Trading Engine Core",
        "paths": [
          "engine/app.py",
          "engine/runtime",
          "engine/core"
        ]
      },
      {
        "name": "Strategies & Risk",
        "paths": [
          "engine/strategies",
          "engine/risk.py"
        ]
      },
      {
        "name": "Ops APIs & Automation",
        "paths": [
          "ops",
          "dashboard/app.py"
        ]
      },
      {
        "name": "Data & Backtesting",
        "paths": [
          "services/backtester",
          "services/data_ingester",
          "backtests"
        ]
      },
      {
        "name": "ML Service",
        "paths": [
          "ml_service",
          "services/ml_service"
        ]
      },
      {
        "name": "CI/CD & Tooling",
        "paths": [
          ".github/workflows",
          "Makefile",
          "ops/scripts"
        ]
      },
      {
        "name": "Compliance & Runbooks",
        "paths": [
          "docs",
          "README_DEPLOYMENT.md",
          "NAUTILUS_BINANCE_STEP_BY_STEP.md"
        ]
      }
    ],
    "ports": {
      "engine_binance": 8003,
      "engine_binance_exporter": 9103,
      "ops": 8002,
      "executor_metrics": 9102,
      "universe": 8009,
      "screener": 8010,
      "situations": 8011,
      "deck": 8012,
      "data_ingester": 8001,
      "ml_service": 8000,
      "param_controller": 8002,
      "grafana": 3000,
      "prometheus": 9090,
      "alertmanager": 9093,
      "loki": 3100
    },
    "env_map_refs": [
      "OPS_API_TOKEN",
      "OPS_API_TOKEN_FILE",
      "GF_SECURITY_ADMIN_USER",
      "GF_SECURITY_ADMIN_PASSWORD",
      "GF_SECURITY_ADMIN_PASSWORD__FILE"
    ],
    "network_defaults": {
      "frontend_timeout_ms": 10000,
      "executor_httpx_limits": "connect=3s/read=5s/pool=5s limits(8,4)",
      "auto_probe_fallback_limits": "connect=2s/read=4s limits(4,4)"
    },
    "net_docs": [
      "net_checklist.md"
    ],
    "external_endpoints": [
      "engine_binance",
      "ops"
    ],
    "env_map": {
      "TRADING_ENABLED": {
        "defined_in": [
          "config.example.env:4",
          "docker-compose.yml:25"
        ],
        "used_in": [
          "engine/config/__init__.py:136"
        ],
        "default": "false (config), true (engine fallback)"
      },
      "OPS_API_TOKEN": {
        "defined_in": [
          "docker-compose.yml:188",
          "config.example.env:22"
        ],
        "used_in": [
          "ops/ops_api.py:124",
          "ops/ui_api.py:34"
        ],
        "default": "dev-token (code fallback)"
      },
      "OPS_API_TOKEN_FILE": {
        "defined_in": [
          "config.example.env:23",
          "config.schema.json:90"
        ],
        "used_in": [
          "docker-compose.yml:189"
        ],
        "default": "unset"
      },
      "GF_SECURITY_ADMIN_USER": {
        "defined_in": [
          "config.example.env:28",
          "config.schema.json:122"
        ],
        "used_in": [
          "ops/observability/docker-compose.observability.yml:31"
        ],
        "default": "required"
      },
      "GF_SECURITY_ADMIN_PASSWORD_FILE": {
        "defined_in": [
          "config.example.env:29",
          "config.schema.json:132"
        ],
        "used_in": [
          "ops/observability/docker-compose.observability.yml:33"
        ],
        "default": "required via secrets file"
      },
      "HMM_URL": {
        "defined_in": [
          "config.example.env:25",
          "config.schema.json:100"
        ],
        "used_in": [
          "docker-compose.yml:209",
          "ops/main.py:75"
        ],
        "default": "http://ml_service:8000"
      }
    },
    "config_files": [
      "config.example.env",
      "config.schema.json"
    ],
    "secrets_required": [
      "OPS_API_TOKEN or OPS_API_TOKEN_FILE",
      "GF_SECURITY_ADMIN_USER",
      "GF_SECURITY_ADMIN_PASSWORD or GF_SECURITY_ADMIN_PASSWORD_FILE"
    ],
    "logs_contract": "docs/observability/logs_contract.md",
    "slos": "ops/observability/slo.yaml",
    "alert_examples": "docs/observability/alert_examples.yaml",
    "instrumentation_snippets": "docs/observability/instrumentation_snippets.py",
    "strategy_files": [
      "engine/strategies/momentum_15m.py",
      "engine/strategies/meme_coin_sentiment.py",
      "engine/strategies/listing_sniper.py"
    ],
    "risk_defaults": {
      "MIN_NOTIONAL_USDT": 10.0,
      "MAX_NOTIONAL_USDT": 1000.0,
      "EXPOSURE_CAP_SYMBOL_USD": 2000.0,
      "EXPOSURE_CAP_TOTAL_USD": 10000.0
    },
    "risk_notes": [
      "StrategyExecutor gates every signal through RiskRails",
      "Momentum_15m issues quantity-only signals by default"
    ],
    "ml_notes": [
      "EXACTLY_ONCE enabled",
      "Research ledger separated"
    ],
    "ml_paths": {
      "ledger": "/ml/manifest.sqlite",
      "data": "/ml/data"
    }
  },
  "config_issues": 4,
  "container_risks": [
    "Deck service retired; use Ops command center",
    "Core trading services lack resource limits"
  ],
  "env_vars": {
    "OPS_API_TOKEN": "required_secret",
    ".env": "ignored_in_build"
  },
  "secret_sources": [
    "ops/observability/docker-compose.observability.yml",
    "ops/observability/loki/config.yml"
  ],
  "redactions": [
    "Grafana admin password requires secret",
    "Loki logs retention purge required"
  ],
  "slices": [
    {
      "name": "ML & research paths",
      "paths": [
        "services/ml_service",
        "services/backtest_suite",
        "docs/ML_SERVICE_INTEGRATION.md"
      ]
    },
    {
      "name": "Compliance & telemetry",
      "paths": [
        "ops/observability",
        "audit_out/retention_policy.md",
        "audit_out/data_map.csv"
      ]
    }
  ],
  "arch_modules": [
    "trading-engine",
    "ops-api",
    "ml-service",
    "backtest-suite"
  ],
  "hotspots": [
    "ml_service/app/trainer.py",
    "ops/observability/loki/config.yml"
  ],
  "env_map": {
    "LEDGER_DB": {
      "defined_in": [
        "services/backtest_suite/Dockerfile",
        "compose.backtest.yml"
      ],
      "used_in": [
        "services/backtest_suite/app/config.py"
      ],
      "default": "/research/manifest.sqlite"
    },
    "DATA_INCOMING": {
      "defined_in": [
        "services/backtest_suite/Dockerfile",
        "compose.backtest.yml"
      ],
      "used_in": [
        "services/backtest_suite/app/config.py"
      ],
      "default": "/research/incoming"
    },
    "TRAIN_SEED": {
      "defined_in": [
        "services/ml_service/app/config.py"
      ],
      "used_in": [
        "services/ml_service/app/trainer.py"
      ],
      "default": 42
    }
  },
  "config_files": [
    "services/backtest_suite/Dockerfile",
    "compose.backtest.yml"
  ],
  "dep_risks": 0,
  "datastores": [
    "/data/runtime",
    "/models/registry",
    "/shared/manifest.sqlite",
    "/research/manifest.sqlite"
  ],
  "topics": [],
  "ci_jobs": [],
  "gates": [],
  "slis": [],
  "slos": [],
  "alerts": [],
  "ui_bundles": [],
  "a11y_gaps": [],
  "a11y_issues": 0,
  "events": [],
  "pii_blocks": [],
  "perf_hotspots": [],
  "ml_risks": 0,
  "bt_parity_gaps": [],
  "cost_ops": [],
  "dr_gaps": [],
  "data_classes": [
    "operational",
    "metrics",
    "research"
  ],
  "retentions": [
    "operational:30d",
    "ops_audit:90d",
    "research:30d",
    "telemetry:14d"
  ],
  "top10": []
}
