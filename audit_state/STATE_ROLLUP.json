{
  "slices": [
    {
      "name": "T-00 Recon & Inventory",
      "paths": [
        "."
      ]
    },
    {
      "name": "T-ARCH Architecture Alignment",
      "paths": [
        "docs/SYSTEM_DESIGN.md",
        "engine",
        "services"
      ]
    },
    {
      "name": "T-CFG Config & Settings",
      "paths": [
        "config",
        "config.schema.json",
        "env.example",
        "ops/observability"
      ]
    },
    {
      "name": "T-CTRL-API Control Plane",
      "paths": [
        "ops/ui_api.py",
        "ops/strategy_router.py",
        "tests/ui"
      ]
    },
    {
      "name": "T-CTRL-UI Ops Dashboard",
      "paths": [
        "frontend/src/components",
        "frontend/src/lib",
        "frontend/src/App.tsx"
      ]
    },
    {
      "name": "T-FUNDS Dynamic Funds",
      "paths": [
        "ops/capital_allocator.py",
        "ops/policies.yaml",
        "ops/capital_policy.json"
      ]
    },
    {
      "name": "T-SELECT Strategy Selection",
      "paths": [
        "ops/strategy_registry.json",
        "ops/m25_governor.py",
        "engine"
      ]
    },
    {
      "name": "T-CFG-DYN Remote Config",
      "paths": [
        "ops/policies.backup.yaml",
        "ops/observability/grafana",
        "config"
      ]
    },
    {
      "name": "T-SYMBOLS Universe",
      "paths": [
        "universe",
        "ops/universe_state.json",
        "ops/policies.yaml"
      ]
    },
    {
      "name": "T-LOOP-LEARN ML Loop",
      "paths": [
        "ml_service",
        "ops/train_backfill_one.py",
        "backtests"
      ]
    },
    {
      "name": "T-HITL Human Safeguards",
      "paths": [
        "ops/governance_daemon.py",
        "docs/OPS_RUNBOOK.md",
        "ops/runbook.md"
      ]
    },
    {
      "name": "Observability, Resilience & Deployment",
      "paths": [
        "ops/observability",
        "docker-compose.yml",
        "compose.autotrain.yml",
        "compose.backfill.yml",
        "compose.ml.yml",
        "ops/quickcheck.sh"
      ]
    }
  ],
  "arch_components": [
    {
      "component": "Strategy & ML Layer",
      "docs": [
        "docs/SYSTEM_DESIGN.md#2-strategy-ml-layer"
      ],
      "code": [
        "engine/strategy.py",
        "engine/strategies/",
        "ml_service/app.py",
        "ops/strategy_router.py"
      ],
      "notes": "Strategy loop, ensemble policies, and optional external ML service align with documented flow."
    },
    {
      "component": "Execution Engine & Risk",
      "docs": [
        "docs/SYSTEM_DESIGN.md#1-execution-plane-engine"
      ],
      "code": [
        "engine/app.py",
        "engine/core/",
        "engine/risk.py",
        "engine/state/",
        "engine/storage/sqlite.py"
      ],
      "notes": "FastAPI engine, order router, risk rails, and persistence layers present as described."
    },
    {
      "component": "Ops Control Plane",
      "docs": [
        "docs/SYSTEM_DESIGN.md#3-ops-governance-layer-ops"
      ],
      "code": [
        "ops/ops_api.py",
        "ops/ui_api.py",
        "ops/ui_state.py",
        "ops/prometheus.py"
      ],
      "notes": "Control endpoints and UI router live under ops, matching documentation."
    },
    {
      "component": "Governance & Capital Allocation",
      "docs": [
        "docs/SYSTEM_DESIGN.md#3-ops-governance-layer-ops"
      ],
      "code": [
        "ops/capital_allocator.py",
        "ops/m25_governor.py",
        "ops/governance_daemon.py",
        "ops/strategy_weights.json",
        "ops/capital_policy.json"
      ],
      "notes": "Capital allocator and governor daemons exist; configs mostly present."
    },
    {
      "component": "Universe/Screener/Situations Services",
      "docs": [
        "docs/SYSTEM_DESIGN.md#3-ops-governance-layer-ops",
        "docs/SYSTEM_DESIGN.md#5-data-event-flow"
      ],
      "code": [
        "universe/service.py",
        "screener/service.py",
        "situations/service.py"
      ],
      "notes": "Ancillary services align with data flow narrative."
    },
    {
      "component": "Observability Stack",
      "docs": [
        "docs/SYSTEM_DESIGN.md#4-observability-persistence",
        "docs/SYSTEM_DESIGN.md#observability-bundle"
      ],
      "code": [
        "ops/observability/",
        "docs/observability/"
      ],
      "notes": "Prometheus/Grafana/Loki configs exactly under documented directories."
    },
    {
      "component": "Frontend Command Center",
      "docs": [
        "docs/SYSTEM_DESIGN.md"
      ],
      "code": [
        "frontend/src/App.tsx",
        "frontend/src/components/",
        "frontend/src/lib/"
      ]
    },
    {
      "component": "Data Persistence",
      "docs": [
        "docs/SYSTEM_DESIGN.md#4-observability-persistence"
      ],
      "code": [
        "engine/logs/",
        "engine/state/",
        "data/runtime/"
      ],
      "notes": "JSONL logs, snapshots, and SQLite queues match storage description."
    }
  ],
  "broken_links": [
    {
      "doc": "docs/SYSTEM_DESIGN.md#governance-automation",
      "reference": "ops/m20_playbook.py",
      "issue": "File not present in repo; governance playbook path likely renamed or removed."
    },
    {
      "doc": "docs/SYSTEM_DESIGN.md#configuration-surfaces",
      "reference": "ops/capital_allocations.json",
      "issue": "Config file absent; allocator now uses strategy_weights.json/capital_policy.json."
    },
    {
      "doc": "docs/SYSTEM_DESIGN.md#built-in-strategy-loop",
      "reference": "engine/models/active_hmm_policy.pkl",
      "issue": "Runtime artifact not versioned; consider documenting storage location or publishing sample."
    }
  ],
  "env_map": {
    "engine": {
      "defaults": [
        "engine/config/defaults.py:22",
        "engine/config/defaults.py:48",
        "config.schema.json:6"
      ],
      "examples": [
        "config.example.env:3",
        "env.example:5"
      ],
      "overrides": [
        ".env:1",
        "docker-compose.yml:88"
      ],
      "secrets": [
        "compose.hardening.override.yaml:22"
      ]
    },
    "ops_api": {
      "defaults": [
        "config.example.env:21"
      ],
      "overrides": [
        ".env:94"
      ],
      "required": [
        "OPS_API_TOKEN"
      ],
      "secrets": [
        "compose.hardening.override.yaml:4"
      ],
      "secret_file": "config.example.env:24"
    },
    "observability": {
      "defaults": [
        "config.example.env:31"
      ],
      "overrides": [
        ".env:307",
        "ops/observability/docker-compose.observability.yml:31"
      ],
      "secrets": [
        "compose.hardening.override.yaml:15"
      ],
      "notes": "Grafana admin password provided via secret file per config.example.env:33"
    },
    "ml_service": {
      "defaults": [
        "config.example.env:35",
        "engine/config/defaults.py:205"
      ],
      "overrides": [
        "compose.ml.yml:12",
        "compose.autotrain.yml:27"
      ],
      "ledger": [
        "compose.autotrain.yml:29",
        "compose.autotrain.yml:49"
      ],
      "compose_env": "compose.ml.yml"
    },
    "data_ingester": {
      "defaults": [
        "config.example.env:44",
        "engine/config/defaults.py:189"
      ],
      "overrides": [
        "compose.autotrain.yml:9",
        "compose.backfill.yml:10"
      ],
      "notes": "Shared ledger path reused by ML + ingester"
    },
    "param_controller": {
      "defaults": [
        "config.schema.json:234"
      ],
      "overrides": [
        "compose.autotrain.yml:64"
      ]
    },
    "dex_bridge": {
      "overrides": [
        ".env:220"
      ],
      "notes": "DEX_* variables only present in operator .env; keep private keys injected via external secret manager."
    },
    "engine_core": {
      "defaults": [
        "config.example.env:3",
        "engine/config/defaults.py:22"
      ],
      "overrides": [
        ".env:1"
      ],
      "notes": "Risk rails & trading toggles derive from defaults.py and are lifted by env/config loaders."
    },
    "binance": {
      "required": [
        "BINANCE_API_KEY",
        "BINANCE_API_SECRET"
      ],
      "defaults": [
        "config.example.env:11"
      ],
      "overrides": [
        ".env:81"
      ],
      "secrets_path": "compose.hardening.override.yaml mounts /run/secrets"
    },
    "strategies": {
      "defaults": [
        "engine/config/defaults.py:48",
        "engine/config/defaults.py:145"
      ],
      "overrides": [
        ".env:22"
      ],
      "notes": "Feature switches for trend/momentum/meme/listing strategies centralised in defaults"
    }
  },
  "ports": [
    "engine_binance:8003",
    "engine_binance_exporter:9103",
    "ops:8002",
    "executor:9102",
    "universe:8009",
    "screener:8010",
    "situations:8011",
    "data_ingester:8001",
    "ml_service:8000"
  ],
  "datastores": [],
  "topics": [],
  "control_api": [
    {
      "component": "App.tsx handleModeChange",
      "ui_ref": "frontend/src/App.tsx:231",
      "endpoint": "PUT /api/config",
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": "generateIdempotencyKey('mode-${newMode}')"
    },
    {
      "component": "App.tsx handlePause",
      "ui_ref": "frontend/src/App.tsx:261",
      "endpoint": "POST /api/ops/kill-switch",
      "payload": {
        "enabled": false
      },
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": "generateIdempotencyKey('pause')"
    },
    {
      "component": "App.tsx handleResume",
      "ui_ref": "frontend/src/App.tsx:279",
      "endpoint": "POST /api/ops/kill-switch",
      "payload": {
        "enabled": true
      },
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": "generateIdempotencyKey('resume')"
    },
    {
      "component": "App.tsx handleFlatten",
      "ui_ref": "frontend/src/App.tsx:295",
      "endpoint": "POST /api/ops/flatten",
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": "generateIdempotencyKey('flatten')"
    },
    {
      "component": "App.tsx handleKillSwitch",
      "ui_ref": "frontend/src/App.tsx:315",
      "endpoint": "POST /api/ops/kill-switch + POST /api/ops/flatten",
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": [
        "generateIdempotencyKey('kill-pause')",
        "generateIdempotencyKey('kill-flatten')"
      ],
      "requires_reason": true
    },
    {
      "component": "SettingsTab handleSubmit",
      "ui_ref": "frontend/src/components/tabs/SettingsTab.tsx:140",
      "endpoint": "PUT /api/config",
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor",
        "Idempotency-Key"
      ],
      "idempotency_source": "generateIdempotencyKey('config')"
    },
    {
      "component": "useWebSocket requestSession",
      "ui_ref": "frontend/src/lib/websocket.ts:260",
      "endpoint": "POST /api/ops/ws-session",
      "headers": [
        "X-Ops-Token",
        "X-Ops-Actor"
      ],
      "idempotency_source": "generateIdempotencyKey('ws-session')"
    }
  ],
  "ops_actions": [
    "strategy_promote",
    "router_weight_sync"
  ],
  "rbac": {
    "roles": {
      "viewer": {
        "description": "Read-only access to dashboards and health widgets",
        "capabilities": [
          "read:dashboard",
          "read:metrics",
          "read:alerts"
        ]
      },
      "operator": {
        "description": "Authenticated operator with OPS token and call-sign",
        "capabilities": [
          "viewer",
          "control:pause",
          "control:resume",
          "control:flatten",
          "config:patch",
          "ws:session"
        ]
      }
    },
    "ui_requirements": [
      {
        "control": "TopHUD.pause",
        "requires": "operator"
      },
      {
        "control": "TopHUD.resume",
        "requires": "operator"
      },
      {
        "control": "TopHUD.flatten",
        "requires": "operator"
      },
      {
        "control": "TopHUD.kill",
        "requires": "operator"
      },
      {
        "control": "SettingsTab.saveOverrides",
        "requires": "operator"
      },
      {
        "control": "WebSocket.connect",
        "requires": "operator"
      }
    ],
    "storage": {
      "opsAuth": {
        "persisted": false,
        "source": "frontend/src/lib/store.ts:84",
        "notes": "OPS credentials remain in-memory and are never stored in localStorage"
      }
    },
    "permissions": [
      {
        "capability": "control:config_patch",
        "endpoint": "PUT /api/config",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:339-356"
      },
      {
        "capability": "control:kill_switch",
        "endpoint": "POST /api/ops/kill-switch",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:444-466"
      },
      {
        "capability": "control:flatten",
        "endpoint": "POST /api/ops/flatten",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:470-495"
      },
      {
        "capability": "strategy:lifecycle",
        "endpoint": "POST /api/strategies/{id}/start|stop|update",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:673-760"
      },
      {
        "capability": "backtest:start",
        "endpoint": "POST /api/backtests",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:832-908"
      },
      {
        "capability": "config:reload",
        "endpoint": "POST /api/governance/reload",
        "guard": "TokenOnlyGuard",
        "source": "ops/ui_api.py:499-520"
      },
      {
        "capability": "strategy:patch",
        "endpoint": "PATCH /api/strategies/{id}",
        "guard": "require_ops_token",
        "source": "ops/ui_api.py:369-376"
      },
      {
        "capability": "funds:transfer",
        "endpoint": "POST /api/account/transfer",
        "guard": "require_ops_token",
        "source": "ops/ui_api.py:547-552"
      }
    ],
    "gaps": [
      {
        "issue": "strategy_patch_missing_idempotency",
        "endpoint": "PATCH /api/strategies/{id}",
        "impact": "Single operator can patch strategies without an idempotency key or audit payload.",
        "source": "ops/ui_api.py:369-376"
      },
      {
        "issue": "fund_transfer_no_idempotency",
        "endpoint": "POST /api/account/transfer",
        "impact": "Transfers execute with a single OPS token and no idempotency tracking.",
        "source": "ops/ui_api.py:547-552"
      },
      {
        "issue": "viewer_role_not_distinct",
        "endpoint": "POST /api/ops/ws-session",
        "impact": "Backend cannot distinguish viewers from operators; X-Ops-Actor remains optional and unverified.",
        "source": "ops/ui_api.py:245-260"
      }
    ],
    "session": {
      "ws_ttl_seconds": 900,
      "source": "ops/ui_api.py:216-258",
      "notes": "WS session secrets live in-process only; rotation requires revoking OPS token or restarting service."
    }
  },
  "policy_guards": [
    "universe_age_cooldown",
    "quarantine_promotion_checks"
  ],
  "budgets": {
    "base_equity_frac": 0.2,
    "min_pool_usd": 10000.0,
    "reserve_equity_usd": 5000.0,
    "model_targets": {
      "stable_model": 0.7,
      "canary_model": 0.3
    }
  },
  "alloc_constraints": {
    "min_quota_usd": 250.0,
    "max_quota_usd": 25000.0,
    "step_up_pct": 0.15,
    "step_down_pct": 0.2,
    "cooldown_sec": 900
  },
  "selector": "sharpe_rank_promote",
  "gates": {
    "healthchecks": "docker-compose.yml defines curl-based health probes for engine and ops (readyz endpoints) with generous start periods.",
    "logging": "All services use json-file logging with 10MB/3-file rotation to cap Docker.raw growth.",
    "secrets": "Grafana admin password expected via GF_SECURITY_ADMIN_PASSWORD__FILE; OPS_API_TOKEN sourced via env or secret file for the ops service.",
    "min_samples": 3,
    "min_trades": 50,
    "improvement_threshold": 0.05,
    "manual_override": true
  },
  "universe_policy": {
    "venue": "BINANCE",
    "quote": "USDT",
    "scan_interval_sec": 60,
    "thresholds": {
      "min_notional_per_min": 5000,
      "max_spread_atr": 1.2,
      "min_depth_usdt": 5000,
      "ignition": {
        "turnover_mult": 8.0,
        "tradecount_mult": 5.0,
        "atrp_min": 0.015
      },
      "quarantine": {
        "min_age_minutes": 360,
        "safe_scans": 3
      },
      "demotion": {
        "notional_drop_mult": 0.33,
        "cb_hits": 2
      }
    }
  },
  "tiers": {
    "runtime_buckets": [
      "quarantine",
      "candidate",
      "retired"
    ],
    "static_ops_buckets": [
      "trend",
      "momentum",
      "scalper",
      "event"
    ]
  },
  "closed_loop": true,
  "gates_live": {
    "ledger": "/shared/manifest.sqlite",
    "hmm_url": "http://ml_service:8000",
    "param_controller": "http://param_controller:8002",
    "exactly_once_default": true,
    "compose_override": "EXACTLY_ONCE=${ML_EXACTLY_ONCE:-true}",
    "promotion_delta": 1.0
  },
  "hitl": {
    "single_operator": "Critical controls now rely on a single OPS token plus audit call-sign (ops/ui_api.py:444-495; frontend/src/App.tsx:160-207).",
    "kill_reason_prompt": "frontend/src/App.tsx:126-144 requires operators to enter a reason before invoking the kill switch.",
    "control_audit_log": "ops/ui_api.py:346-520 logs every mutation to ops/logs/control_actions.jsonl via _record_control_action.",
    "runbook_handoffs": "docs/OPS_RUNBOOK.md:20-63 documents pause/resume workflows with optional audit call-signs."
  },
  "cooldowns": {
    "governance_actions": "ops/governance_daemon.py:176-212 tracks last_actions per rule and enforces cooldown_seconds before re-triggering.",
    "ui_control_state": "frontend/src/App.tsx:179-188 holds controlState to prevent duplicate submissions while awaiting response."
  },
  "shadow_mode": true,
  "smoke_checks": [
    "curl -fsS http://localhost:8003/readyz",
    "curl -fsS http://localhost:8002/readyz",
    "python - <<'PY'\nimport asyncio\nfrom ops.net import create_async_client, request_with_retry\nasync def main():\n    async with create_async_client() as client:\n        resp = await request_with_retry(client, 'GET', 'http://engine_binance:8003/version')\n        print(resp.status_code)\nasyncio.run(main())\nPY"
  ],
  "ci_jobs": [
    "make prom-reload",
    "make grafana-restart"
  ],
  "gates_ci": [
    "docker compose -f docker-compose.yml config",
    "docker compose -f docker-compose.yml -f compose.autotrain.yml config"
  ],
  "slis": [
    "histogram_quantile(0.95, sum by (le) (rate(fill_latency_ms_bucket[5m])))",
    "sum(rate(http_requests_total{service=\"ops-api\",status!~\"5..\"}[5m])) / sum(rate(http_requests_total{service=\"ops-api\"}[5m]))",
    "realtime_heartbeat_age_seconds"
  ],
  "slos": [
    "trading-latency <= 1500ms P95 over 7d",
    "ops-api availability >= 99.5% over 30d",
    "websocket heartbeat age <= 30s for 99% of samples"
  ],
  "alerts": [
    "ExternalFeedStale",
    "MarginLevelCritical",
    "KrakenExposureBreach",
    "PromoOrderBudgetSpike",
    "KrakenTelemetryStale"
  ],
  "dep_risks": 1,
  "perf_hotspots": [
    "signal_queue_unbounded"
  ],
  "api_guidelines": {
    "doc": "docs/api_guidelines.md",
    "resource_naming": [
      "Prefer plural nouns for collections and nest subordinate resources (e.g. /strategies/{id}/positions).",
      "Keep imperatives out of URIs; express actions via POST body enums or /actions/{verb} suffix when unavoidable."
    ],
    "versioning": {
      "strategy": "Path-based namespace (/api/v1) with optional X-API-Version header for forward negotiation.",
      "sunset_policy": "Advertise supported versions via X-API-Versions response header and publish deprecation timelines in docs/CHANGELOG.md.",
      "status": "Header added to OpenAPI; runtime still serves unversioned /api routes."
    },
    "error_model": {
      "schema": "error.code + error.message + optional details + requestId.",
      "status": "Documented in OpenAPI components; FastAPI handlers still emit bare detail strings."
    },
    "pagination": {
      "pattern": {
        "cursor": "cursor",
        "limit": "limit",
        "sort": "sort",
        "filters": "filter[field]=value"
      },
      "response_envelope": "data + page.nextCursor/page.prevCursor/page.limit/page.totalHint",
      "status": "Strategies, positions, trades, and alerts now emit cursor-based envelopes; remaining collections (e.g. metrics detail feeds) still pending."
    },
    "idempotency": {
      "required_headers": [
        "Idempotency-Key"
      ],
      "gaps": [
        "/api/orders/cancel",
        "/api/account/transfer",
        "/api/events/trade"
      ]
    }
  },
  "openapi_updates": {
    "file": "docs/command_center_openapi.yaml",
    "changes": [
      "Removed two-man approval references; documented single-operator guardrails.",
      "Added X-API-Version header parameter and default error response schema.",
      "Documented paginated responses for strategies, trades, alerts, and positions."
    ]
  },
  "gaps": [
    "Runtime has not yet issued X-API-Versions headers or enforced version negotiation.",
    "Control mutations lack uniform error envelopes; FastAPI should marshal exceptions into ErrorResponse.",
    "Additional collections (e.g. dashboard metrics) remain unpaginated; extend cursor helpers before v1 freeze."
  ],
  "policy_guard_details": {
    "ops_token_rotation_gap": "OPS_API_TOKEN is cached in-process (ops/middleware/control_guard.py:20-82); add a reload endpoint or watcher to rotate secrets without restart.",
    "ws_message_once_guard": "App.tsx (frontend/src/App.tsx:193-200) memoizes the last processed WebSocket payload so React Query hydration runs at most once per message, preventing nested rerender loops."
  },
  "authz_findings": [
    "Strategic PATCH operations use single-token auth without idempotency or dual-signature, allowing accidental double submits.",
    "POST /api/account/transfer reuses require_ops_token with no replay protection; consider adding IdempotentGuard.",
    "WS session issuance still trusts optional X-Ops-Actor and does not separate viewer credentials."
  ],
  "config_files": [
    {
      "path": "config/runtime.yaml",
      "purpose": "Risk budgets, symbol buckets, futures leverage",
      "notes": "Overrides runtime.example.yaml and is consumed by ops/state loaders"
    },
    {
      "path": "config/universe.yaml",
      "purpose": "Universe service filters & tiers",
      "notes": "Sits alongside runtime for symbol governance"
    },
    {
      "path": "config/screener.yaml",
      "purpose": "Screener thresholds and data sources",
      "notes": "Piped into screener/service.py"
    },
    {
      "path": "config/situations.json",
      "purpose": "Situational alerts definitions",
      "notes": "Used by situations/service.py"
    },
    {
      "path": "config/external_feeds.yaml",
      "purpose": "Webhook/feed credentials",
      "notes": "Ops notify + external integrations"
    },
    {
      "path": "ops/policies.yaml",
      "purpose": "Governance rules & kill-switches",
      "notes": "Read by ops/governance_daemon.py"
    },
    {
      "path": "ops/policies.backup.yaml",
      "purpose": "Fallback copy for remote config",
      "notes": "Maintained by ops/policies tooling"
    },
    {
      "path": "ops/observability/prometheus/prometheus.yml",
      "purpose": "Prometheus scrape config",
      "notes": "Augmented by docker-compose.observability.yml"
    },
    {
      "path": "docker-compose.yml",
      "purpose": "Service env injection order",
      "notes": "Compose env & .env precedence"
    }
  ],
  "config_store": {
    "primary": "ops/policies.yaml",
    "fallback": "ops/policies.backup.yaml",
    "loader": "ops/governance_daemon.py:61-162",
    "reload_interface": "ops/governance_daemon.py:411-421",
    "distribution": "manual file sync (no remote store)"
  },
  "audit_trail": true,
  "notes": [
    "All updates preserve public APIs; changes limited to guarding equality and throttling repeated side effects."
  ],
  "top5": [
    "strategy_patch_missing_idempotency",
    "fund_transfer_no_idempotency",
    "ops_token_rotation_gap",
    "viewer_role_not_distinct",
    "ws_actor_optional"
  ],
  "framework": "React 18 + Vite + TypeScript + TanStack Query 5 + Zustand",
  "frontend_root": "frontend",
  "live_flags": {
    "websocket": "VITE_WS_URL (defaults to ws://localhost:8002/ws)",
    "polling_disable": "VITE_LIVE_OFF=true disables usePolling timers and WebSocket hydrate"
  },
  "suspects": [
    {
      "id": "ws-app-query-hydrate",
      "type": "effect-dep-mutates-dep",
      "source": "frontend/src/App.tsx:192-235",
      "downstream": [
        "TanStack Query cache for dashboard.summary/health",
        "App render -> TopHUD metrics props -> React Query observers"
      ],
      "symptoms": [
        "Stack trace references TanStack forceStoreRerender",
        "Loop reproduces when websocket metrics stream is live"
      ],
      "notes": "WebSocket handler pushes every payload into query cache via setQueryData inside an effect that depends on lastMessage. Message objects lack stable identity/diffing, so every notification rehydrates queries even when unchanged. React Query notifies subscribers synchronously, retriggering the same effect before the guard records a processed hash.",
      "instrument_plan": [
        "Wrap App with dev-only render counter (whyDidYouUpdate) to log metrics message ids",
        "Log query cache writes for dashboard.summary to confirm duplicate writes"
      ]
    },
    {
      "id": "ws-session-recursion",
      "type": "effect-dep-mutates-dep",
      "source": "frontend/src/lib/websocket.ts:244-309",
      "downstream": [
        "useWebSocket state machine (wsSession, managerRef)",
        "App re-render because hook returns new session state"
      ],
      "symptoms": [
        "When OPS tokens missing or invalid, session issuance re-runs on every render",
        "managerRef.disconnect() + setWsSession(null) fire before previous effect cleanup"
      ],
      "notes": "Effect recomputes trimmed token/actor each render. On error the catch sets wsSession(null) which is already null, but React still schedules state work. Combined with StrictMode double-invoke, the hook re-requests a session rapidly, keeping the component in an update loop once backend responds with errors.",
      "instrument_plan": [
        "Add console.count in dev to track session requests",
        "Mock issueWebsocketSession in tests and assert no re-request without credentials"
      ]
    },
    {
      "id": "polling-fn-identity",
      "type": "timer/subscription recreated without cleanup",
      "source": "frontend/src/lib/hooks.ts:3-46",
      "downstream": [
        "Consumers passing inline poller functions (e.g. BacktestingTab)",
        "Repeated timer setup tears down previous but can interleave updates leading to synchronous setState bursts"
      ],
      "symptoms": [
        "When fn identity changes per render, tick() fires immediately and schedules the next timeout, stacking multiple pending promises",
        "Combined with optimistic UI (setJobSnapshot) the component can oscillate between job states"
      ],
      "notes": "usePolling stores fn in dependency array. If consumers forget to memoize, every render recreates the timer, immediately calling tick() and setData(), causing clustered state updates. Need a stable fn or internal ref guard."
    }
  ],
  "loop_graph": [
    {
      "source": "WebSocket message -> useWebSocket.handleMessage",
      "edge": "updateGlobalMetrics/venues -> Zustand realTimeData",
      "target": "App + dashboard queries recompute",
      "risk": "Repeated query cache writes trigger React Query forceStoreRerender leading to depth overflow"
    },
    {
      "source": "useWebSocket session effect",
      "edge": "issueWebsocketSession retries -> setWsSession(null)",
      "target": "App effect waiting on lastMessage re-invokes before cleanups finish",
      "risk": "Credential-less mode spins session fetch loop"
    },
    {
      "source": "usePolling tick timer",
      "edge": "setData -> component state setter",
      "target": "Component render -> re-creates polling fn",
      "risk": "Timer churn causes back-to-back state updates without delays"
    }
  ],
  "instrumentation_todo": [
    "Add dev-only render counter hook (whyDidYouUpdate) to App, TopHUD, DashboardTab",
    "Enable TanStack Query logger to confirm cache write frequency",
    "Write Vitest harness that mounts App with mocked WS to observe render counts"
  ],
  "patches": [
    {
      "file": "frontend/src/App.tsx",
      "summary": "Debounce WebSocket-derived React Query writes using message tokens and serialized digests so no-ops skip cache updates.",
      "rationale": "Prevents identical metrics/health payloads from triggering new query cache objects, eliminating the effect-dep-mutates-dep loop that hit Reactâ€™s maximum update depth.",
      "loop_fixed": "ws-app-query-hydrate"
    },
    {
      "file": "frontend/src/lib/websocket.ts",
      "summary": "Throttle websocket session issuance per credential pair with in-flight guard and back-off after failures.",
      "rationale": "Stops StrictMode double-run from repeatedly requesting sessions when ops credentials stay unchanged, preventing the session spin loop.",
      "loop_fixed": "ws-session-recursion"
    },
    {
      "file": "frontend/src/lib/hooks.ts",
      "summary": "Stabilise polling timers by pinning async fn/comparator in refs so timer effect only depends on interval + enabled state.",
      "rationale": "Avoids recreating timers/setState bursts when consumers inline the polling function, eliminating timer churn loops.",
      "loop_fixed": "polling-fn-identity"
    }
  ]
}
