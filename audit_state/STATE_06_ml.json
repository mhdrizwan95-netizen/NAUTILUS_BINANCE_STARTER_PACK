{
  "findings": [
    {
      "id": "ml-registry-not-exactly-once",
      "severity": "S1",
      "area": "ml",
      "file": "services/ml_service/app/config.py",
      "lines": "7-24",
      "evidence": "Training defaults point to /shared/manifest.sqlite with EXACTLY_ONCE=False, so the ML service reuses historical bars and can process the same CSV repeatedly, skewing retraining stats.",
      "impact": "Backtests and live retraining share the same ledger path, causing data leakage between research runs and production retrains, and making it impossible to reason about model lineage.",
      "fix": "Set EXACTLY_ONCE=True by default and add research-specific defaults for LEDGER_DB/DATA_INCOMING (or configurable path separation).",
      "diff": "diff --git a/services/ml_service/app/config.py b/services/ml_service/app/config.py\n@@\n-    EXACTLY_ONCE: bool = (\n-        False  # if true: use only new bars > training watermark (no reuse)\n-    )\n+    EXACTLY_ONCE: bool = True  # process each ingested file once for production retraining\n+    LEDGER_DB: str = Field('/ml/manifest.sqlite')\n+    DATA_DIR: str = Field('/ml/data')"
    },
    {
      "id": "ml-model-metadata-seed",
      "severity": "S2",
      "area": "ml",
      "file": "services/ml_service/app/inference.py",
      "lines": "1-60",
      "evidence": "Active model watcher loads joblib artifacts without verifying metadata or random seeds, so successive retrains may produce non-deterministic models without a seed capture.",
      "impact": "Inability to reproduce a promoted model since training randomness (GaussianHMM, KMeans) depends on hard-coded seeds and metadata lacks RNG state.",
      "fix": "Capture RNG seeds in metadata and allow override via config so retraining can be reproduced.",
      "diff": "(documented patch to add seed capture)"
    }
  ],
  "risk_rollup": {
    "S0": 0,
    "S1": 1,
    "S2": 1,
    "S3": 0
  },
  "tickets": [
    {
      "title": "Isolate ML retraining ledger and capture RNG seeds",
      "owner": "ml",
      "eta": "3d",
      "blocks": [],
      "acceptance": [
        "ML retrains read from /ml/manifest.sqlite and delete-after-process",
        "Model metadata includes training seed and feature version",
        "Backtest suite uses /research manifests"
      ]
    }
  ],
  "state": {
    "ml_notes": [
      "EXACTLY_ONCE enabled",
      "Research ledger separated"
    ],
    "ml_paths": {
      "ledger": "/ml/manifest.sqlite",
      "data": "/ml/data"
    }
  }
}
