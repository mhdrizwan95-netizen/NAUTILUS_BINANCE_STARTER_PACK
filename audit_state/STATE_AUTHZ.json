{
  "rbac": {
    "roles": {
      "viewer": {
        "description": "Read-only access to dashboards and health widgets",
        "capabilities": [
          "read:dashboard",
          "read:metrics",
          "read:alerts"
        ]
      },
      "operator": {
        "description": "Single-operator mode with OPS token and call-sign",
        "capabilities": [
          "viewer",
          "control:pause",
          "control:resume",
          "control:flatten",
          "config:patch",
          "ws:session"
        ]
      }
    },
    "ui_requirements": [
      { "control": "TopHUD.pause", "requires": "operator" },
      { "control": "TopHUD.resume", "requires": "operator" },
      { "control": "TopHUD.flatten", "requires": "operator" },
      { "control": "TopHUD.kill", "requires": "operator" },
      { "control": "SettingsTab.saveOverrides", "requires": "operator" },
      { "control": "WebSocket.connect", "requires": "operator" }
    ],
    "storage": {
      "opsAuth": {
        "persisted": false,
        "source": "frontend/src/lib/store.ts:84",
        "notes": "OPS token + actor live only in-memory; refreshing clears credentials."
      }
    },
    "permissions": [
      {
        "capability": "control:config_patch",
        "endpoint": "PUT /api/config",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:339-356"
      },
      {
        "capability": "control:kill_switch",
        "endpoint": "POST /api/ops/kill-switch",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:444-466"
      },
      {
        "capability": "control:flatten",
        "endpoint": "POST /api/ops/flatten",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:470-495"
      },
      {
        "capability": "strategy:lifecycle",
        "endpoint": "POST /api/strategies/{id}/start|stop|update",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:673-760"
      },
      {
        "capability": "backtest:start",
        "endpoint": "POST /api/backtests",
        "guard": "IdempotentGuard",
        "source": "ops/ui_api.py:832-908"
      },
      {
        "capability": "config:reload",
        "endpoint": "POST /api/governance/reload",
        "guard": "TokenOnlyGuard",
        "source": "ops/ui_api.py:499-520"
      },
      {
        "capability": "strategy:patch",
        "endpoint": "PATCH /api/strategies/{id}",
        "guard": "require_ops_token",
        "source": "ops/ui_api.py:369-376"
      },
      {
        "capability": "funds:transfer",
        "endpoint": "POST /api/account/transfer",
        "guard": "require_ops_token",
        "source": "ops/ui_api.py:547-552"
      }
    ],
    "gaps": [
      {
        "issue": "strategy_patch_missing_idempotency",
        "endpoint": "PATCH /api/strategies/{id}",
        "impact": "Single operator can patch strategies without an idempotency key or audit payload.",
        "source": "ops/ui_api.py:369-376"
      },
      {
        "issue": "fund_transfer_no_idempotency",
        "endpoint": "POST /api/account/transfer",
        "impact": "Transfers execute with a single OPS token and no idempotency tracking.",
        "source": "ops/ui_api.py:547-552"
      },
      {
        "issue": "viewer_role_not_distinct",
        "endpoint": "POST /api/ops/ws-session",
        "impact": "Backend cannot distinguish viewers from operators; X-Ops-Actor remains optional and unverified.",
        "source": "ops/ui_api.py:245-260"
      }
    ],
    "session": {
      "ws_ttl_seconds": 900,
      "source": "ops/ui_api.py:216-258",
      "notes": "WS session secrets live in-process only; rotation requires revoking OPS token or restarting service."
    }
  },
  "policy_guards": [
    "ops_token_rotation_gap"
  ],
  "policy_guard_details": {
    "ops_token_rotation_gap": "OPS_API_TOKEN is cached in-process (ops/middleware/control_guard.py:20-82); add a reload endpoint or watcher to rotate secrets without restart."
  },
  "authz_findings": [
    "Strategic PATCH operations use single-token auth without idempotency or dual-signature, allowing accidental double submits.",
    "POST /api/account/transfer reuses require_ops_token with no replay protection; consider adding IdempotentGuard.",
    "WS session issuance still trusts optional X-Ops-Actor and does not separate viewer credentials."
  ]
}
