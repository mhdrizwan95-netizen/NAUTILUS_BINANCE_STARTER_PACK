x-env-common:
  PYTHONPATH: /app
  PROMETHEUS_MULTIPROC_DIR: /tmp/prom_multiproc
  DRY_RUN: ${DRY_RUN:-1}
x-logging: &id001
  driver: json-file
  options:
    max-size: 10m
    max-file: '3'
x-engine-common:
  build: &id002
    context: .
    dockerfile: Dockerfile
  command: '/usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port ${ENGINE_PORT:-8003} --workers 1 --timeout-keep-alive 10 --limit-concurrency 256

    '
  logging: *id001
  dns: &id003
    - 1.1.1.1
    - 8.8.8.8
  environment:
    PYTHONPATH: /app
    PROMETHEUS_MULTIPROC_DIR: /tmp/prom_multiproc
    DRY_RUN: ${DRY_RUN:-1}
    TRADING_ENABLED: ${TRADING_ENABLED:-true}
    MIN_NOTIONAL_USDT: ${MIN_NOTIONAL_USDT:-5}
    MAX_NOTIONAL_USDT: ${MAX_NOTIONAL_USDT:-400}
    MAX_ORDERS_PER_MIN: ${MAX_ORDERS_PER_MIN:-30}
    TRADE_SYMBOLS: ${TRADE_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
    DUST_THRESHOLD_USD: ${DUST_THRESHOLD_USD:-2}
    QUOTE_CCY: ${QUOTE_CCY:-USDT}
    STRATEGY_ENABLED: ${STRATEGY_ENABLED:-false}
    STRATEGY_DRY_RUN: ${STRATEGY_DRY_RUN:-true}
    STRATEGY_SYMBOLS: ${STRATEGY_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
    STRATEGY_INTERVAL_SEC: ${STRATEGY_INTERVAL_SEC:-60}
    STRATEGY_FAST: ${STRATEGY_FAST:-9}
    STRATEGY_SLOW: ${STRATEGY_SLOW:-21}
    STRATEGY_QUOTE_USDT: ${STRATEGY_QUOTE_USDT:-10.0}
    HMM_URL: http://ml_service:8000
    ENGINE_POLL_SEC: ${ENGINE_POLL_SEC:-2}
  healthcheck: &id004
    test:
      - CMD
      - sh
      - -lc
      - curl -fsS http://localhost:8003/health >/dev/null
    interval: 30s
    timeout: 5s
    retries: 10
    start_period: 20s
  depends_on: &id005 []
  tmpfs: &id006
    - /tmp/prom_multiproc:rw,uid=1000,gid=1000,mode=1777
services:
  engine_binance_exporter:
    build: *id002
    command: '/usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 256

      '
    logging: *id001
    dns: *id003
    environment:
      - ROLE=exporter
      - VENUE=BINANCE
      - TRADING_ENABLED=false
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - BINANCE_SPOT_BASE=${BINANCE_SPOT_BASE}
      - BINANCE_FUTURES_BASE=${BINANCE_FUTURES_BASE:-https://fapi.binance.com}
      - DEMO_SPOT_BASE=${DEMO_SPOT_BASE}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - TRADE_SYMBOLS=${TRADE_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
      - BINANCE_API_TIMEOUT=15
      - BINANCE_RECV_WINDOW=60000
      - ENGINE_PORT=8003
      - BINANCE_WS_ENABLED=${BINANCE_WS_ENABLED:-true}
      - OPS_API_TOKEN=${OPS_API_TOKEN:-}
      - OPS_API_TOKEN_FILE=${OPS_API_TOKEN_FILE:-}
    healthcheck: *id004
    depends_on: *id005
    tmpfs: *id006
    container_name: hmm_engine_binance_exporter
    env_file: .env
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
      - ml_models_volume:/app/engine/models:ro
    ports:
      - 9103:8003
    networks:
      - trading_net
  engine_binance:
    build: *id002
    command: '/usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 1024

      '
    logging: *id001
    dns: *id003
    environment:
      - TRADING_ENABLED=true
      - STRATEGY_ENABLED=true
      - HMM_ENABLED=true
      - TREND_ENABLED=true
      - MEME_SENTIMENT_ENABLED=false
      - ROLE=trader
      - VENUE=BINANCE
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - BINANCE_MODE=futures
      - BINANCE_SPOT_BASE=${BINANCE_SPOT_BASE:-https://api.binance.com}
      - BINANCE_FUTURES_BASE=${BINANCE_FUTURES_BASE:-https://fapi.binance.com}
      - DEMO_SPOT_BASE=${DEMO_SPOT_BASE:-https://testnet.binance.vision}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - TRADE_SYMBOLS=${TRADE_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
      - BINANCE_API_TIMEOUT=15
      - BINANCE_RECV_WINDOW=60000
      - ENGINE_PORT=8003
      - BINANCE_WS_ENABLED=${BINANCE_WS_ENABLED:-true}
      - PARAM_CONTROLLER_URL=http://param_controller:8002
      - HMM_MODEL_PATH=/app/engine/models/current/hmm_model.pkl
      - STOP_VALIDATOR_ENABLED=false
      - WATCHDOG_TIMEOUT_SEC=300
      - MARGIN_ENABLED=false
      - BINANCE_MARGIN_ENABLED=false
      - AUTO_TOPUP_ENABLED=false
      - SCALP_ENABLED=true
      - MOMENTUM_RT_ENABLED=true
      # Dynamic Symbol Discovery (SymbolScanner)
      - SYMBOL_SCANNER_ENABLED=true
      - SYMBOL_SCANNER_UNIVERSE=BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT,XRPUSDT,DOGEUSDT,ADAUSDT,AVAXUSDT,LINKUSDT,DOTUSDT,MATICUSDT,SHIBUSDT,LTCUSDT,ATOMUSDT,UNIUSDT,ETCUSDT,XLMUSDT,NEARUSDT,APTUSDT,ARBUSDT
      - SYMBOL_SCANNER_TOP_N=5
      - SYMBOL_SCANNER_INTERVAL_SEC=30
      - SYMBOL_SCANNER_MIN_MINUTES_BETWEEN_RESELECT=0
      - SYMBOL_SCANNER_MIN_VOLUME_USD=500000
      - SYMBOL_SCANNER_MIN_ATR_PCT=0.1
      - OPS_URL=http://ops:8002
      - OPS_TOKEN=${OPS_API_TOKEN:-}
      # Relaxed constraints for dry-run testing
      - TREND_ATR_TARGET_MULT=2.5
      - TREND_ATR_STOP_MULT=1.0
      - TREND_RISK_PCT=0.01
      - SCALP_TP_BPS=25.0
      - SCALP_STOP_BPS=10.0
      - SCALP_MIN_RANGE_BPS=10.0
      - COOLDOWN_SEC=1
      - HMM_MIN_CONF=0.0
      - MIN_CONF=0.0
      - MIN_NOTIONAL_USDT=5
      - STRATEGY_QUOTE_USDT=100
    healthcheck:
      test:
        - CMD
        - sh
        - -lc
        - curl -fsS --max-time 10 http://localhost:8003/readyz >/dev/null
      interval: 15s
      timeout: 8s
      retries: 10
      start_period: 30s
    depends_on: *id005
    tmpfs: *id006
    container_name: hmm_engine_binance
    env_file: .env
    volumes:
      - ./engine:/app/engine:rw
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
      - ml_models_volume:/app/engine/models:ro
      - ./config/external_feeds.yaml:/app/config/external_feeds.yaml:ro
    ports:
      - 8003:8003
    networks:
      - trading_net
  ops:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_ops
    command: '/usr/bin/tini -- uvicorn ops.ops_api:APP --host 0.0.0.0 --port 8002 --workers ${OPS_WORKERS:-2}

      '
    logging: *id001
    environment:
      PYTHONPATH: /app
      PROMETHEUS_MULTIPROC_DIR: /tmp/prom_multiproc
      DRY_RUN: ${DRY_RUN:-1}
      OPS_BASE: http://ops:8002
      DASH_BASE: http://ops:8002
      OPS_DATA_DIR: /app/data
      OPS_API_TOKEN: ${OPS_API_TOKEN:-}
      OPS_API_TOKEN_FILE: ${OPS_API_TOKEN_FILE:-}
      ENGINE_ENDPOINTS: ${ENGINE_ENDPOINTS:-http://engine_binance:8003}
      OPS_METRICS_URL: http://ops:8002/metrics
      SITUATIONS_SSE_URL: http://situations:8011/events/stream
      OPS_METRICS_PORT: ${OPS_METRICS_PORT:-9102}
      BINANCE_MODE: ${BINANCE_MODE}
      BINANCE_API_KEY: ${BINANCE_API_KEY}
      BINANCE_API_SECRET: ${BINANCE_API_SECRET}
      BINANCE_SPOT_BASE: ${BINANCE_SPOT_BASE}
      BINANCE_USDM_BASE: ${BINANCE_USDM_BASE:-${BINANCE_FUTURES_BASE:-https://fapi.binance.com}}
      BINANCE_COINM_BASE: ${BINANCE_COINM_BASE:-https://dapi.binance.com}
      BINANCE_RECV_WINDOW: ${BINANCE_RECV_WINDOW}
      BINANCE_API_TIMEOUT: ${BINANCE_API_TIMEOUT}
      UI_METRICS_SOURCE: direct
      HMM_URL: http://ml_service:8000
      ENGINE_URL: http://engine_binance:8003
    volumes:
      - ./ops:/app/ops:rw
      - ./frontend:/app/frontend:ro
      - ./data:/app/data:rw
    ports:
      - ${OPS_PORT:-8002}:8002
    healthcheck:
      test:
        - CMD-SHELL
        - curl -fsS --max-time 8 http://127.0.0.1:8002/readyz | grep -q '"ok":true'
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 15s
    depends_on:
      engine_binance:
        condition: service_healthy
    networks:
      - trading_net
    tmpfs:
      - /tmp/prom_multiproc:rw,uid=1000,gid=1000,mode=1777
  universe:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_universe
    logging: *id001
    command: '/usr/bin/tini -- uvicorn universe.service:APP --host 0.0.0.0 --port 8009

      '
    ports:
      - 8009:8009
    networks:
      - trading_net
  situations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_situations
    logging: *id001
    command: '/usr/bin/tini -- uvicorn situations.service:APP --host 0.0.0.0 --port 8011

      '
    ports:
      - 8011:8011
    networks:
      - trading_net
  screener:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_screener
    logging: *id001
    command: '/usr/bin/tini -- uvicorn screener.service:APP --host 0.0.0.0 --port 8010

      '
    ports:
      - 8010:8010
    depends_on:
      - universe
      - situations
    networks:
      - trading_net
  data_ingester:
    build:
      context: .
      dockerfile: services/data_ingester/Dockerfile
    image: nautilus_data_ingester:local
    container_name: hmm_data_ingester
    logging: *id001
    profiles:
      - ml
    environment:
      - LEDGER_DB=/ml/manifest.sqlite
      - DATA_LANDING=/ml/incoming
      - EXCHANGE=binance
      - SYMBOLS=BTC/USDT,ETH/USDT
      - TIMEFRAME=1m
      - BATCH_LIMIT=1000
      - START_TS=0
    volumes:
      - ml_data_volume:/ml
    ports:
      - 8013:8001
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - sh
        - -lc
        - curl -fsS --max-time 5 http://localhost:8001/health >/dev/null
      interval: 20s
      timeout: 8s
      retries: 5
    networks:
      - trading_net
  ml_service:
    build:
      context: .
      dockerfile: services/ml_service/Dockerfile
    image: nautilus_ml_service:local
    container_name: hmm_ml_service
    logging: *id001
    profiles:
      - ml
    env_file:
      - .env
    environment:
      - DATA_DIR=/ml/data
      - MODEL_DIR=/models
      - REGISTRY_DIR=/models/registry
      - CURRENT_SYMLINK=/models/current
      - LEDGER_DB=/ml/manifest.sqlite
      - EXACTLY_ONCE=true
      - DELETE_AFTER_PROCESS=true
      - LOG_LEVEL=INFO
    depends_on:
      data_ingester:
        condition: service_started
    volumes:
      - ml_data_volume:/ml
      - ml_models_volume:/models
    ports:
      - 8015:8000
    healthcheck:
      test:
        - CMD
        - curl
        - -fsS
        - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - trading_net
  ml_scheduler:
    image: nautilus_ml_service:local
    container_name: hmm_ml_scheduler
    depends_on:
      ml_service:
        condition: service_healthy
    logging: *id001
    profiles:
      - ml
    env_file:
      - .env
    environment:
      - DATA_DIR=/ml/data
      - MODEL_DIR=/models
      - REGISTRY_DIR=/models/registry
      - CURRENT_SYMLINK=/models/current
      - LEDGER_DB=/ml/manifest.sqlite
      - EXACTLY_ONCE=true
      - DELETE_AFTER_PROCESS=true
      - LOG_LEVEL=INFO
      - RETRAIN_CRON=0 */4 * * *
    command:
      - /bin/bash
      - -c
      - |
        echo "Starting ML Scheduler Loop (Every 4H)..."
        while true; do
          /app/ops/nightly_retrain.sh
          echo "Sleeping for 4 hours..."
          sleep 14400
        done
    volumes:
      - ml_data_volume:/ml
      - ml_models_volume:/models
      - ./:/app
    restart: unless-stopped
    networks:
      - trading_net
  param_controller:
    build:
      context: .
      dockerfile: services/param_controller/Dockerfile
    image: nautilus_param_controller:local
    container_name: hmm_param_controller
    logging: *id001
    profiles:
      - ml
    environment:
      - PC_DB=/shared/param_controller.sqlite
    volumes:
      - ml_shared_volume:/shared
    ports:
      - 8016:8002
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - sh
        - -lc
        - curl -fsS --max-time 5 http://localhost:8002/health >/dev/null
      interval: 20s
      timeout: 8s
      retries: 5
    networks:
      - trading_net
  prometheus:
    image: prom/prometheus:latest
    container_name: hmm_prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
    ports:
      - 9090:9090
    networks:
      - trading_net
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: hmm_grafana
    user: '472'
    depends_on:
      - prometheus
    ports:
      - 3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    env_file:
      - .env
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - trading_net
    restart: unless-stopped
networks:
  trading_net:
    external: true
    name: nautilus_trading_network
volumes:
  ml_data_volume: null
  ml_models_volume: null
  ml_shared_volume: null
  backtest_research_volume: null
  prometheus_data: null
  grafana_data: null
