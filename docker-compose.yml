x-env-common: &env_common
  PYTHONPATH: /app
  PROMETHEUS_MULTIPROC_DIR: /tmp/prom_multiproc

x-engine-common: &engine_common
  build:
    context: .
    dockerfile: Dockerfile
  command: >
    /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port ${ENGINE_PORT:-8003} --workers 1 --timeout-keep-alive 10 --limit-concurrency 256
  environment:
    <<: *env_common
    # Common trading parameters
    TRADING_ENABLED: ${TRADING_ENABLED:-true}
    MIN_NOTIONAL_USDT: ${MIN_NOTIONAL_USDT:-5}
    MAX_NOTIONAL_USDT: ${MAX_NOTIONAL_USDT:-200}
    MAX_ORDERS_PER_MIN: ${MAX_ORDERS_PER_MIN:-30}
    TRADE_SYMBOLS: ${TRADE_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
    DUST_THRESHOLD_USD: ${DUST_THRESHOLD_USD:-2}
    QUOTE_CCY: ${QUOTE_CCY:-USDT}
    # Strategy
    STRATEGY_ENABLED: ${STRATEGY_ENABLED:-false}
    STRATEGY_DRY_RUN: ${STRATEGY_DRY_RUN:-true}
    STRATEGY_SYMBOLS: ${STRATEGY_SYMBOLS:-BTCUSDT,ETHUSDT,BNBUSDT}
    STRATEGY_INTERVAL_SEC: ${STRATEGY_INTERVAL_SEC:-60}
    STRATEGY_FAST: ${STRATEGY_FAST:-9}
    STRATEGY_SLOW: ${STRATEGY_SLOW:-21}
    STRATEGY_QUOTE_USDT: ${STRATEGY_QUOTE_USDT:-10.0}
    # Service dependencies
    HMM_URL: http://ml_service:8010
    ENGINE_POLL_SEC: ${ENGINE_POLL_SEC:-2}
  healthcheck:
    # Lightweight health; avoid hitting account endpoints
    test: ["CMD", "sh", "-lc", "curl -fsS http://localhost:8003/health >/dev/null"]
    interval: 30s
    timeout: 5s
    retries: 10
    start_period: 20s
  depends_on: []

services:
  engine_binance_exporter:
    <<: *engine_common
    container_name: hmm_engine_binance_exporter
    env_file: .env
    environment:
      - ROLE=exporter
      - VENUE=BINANCE
      - TRADING_ENABLED=false
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - BINANCE_MODE=${BINANCE_MODE}
      - BINANCE_SPOT_BASE=${BINANCE_SPOT_BASE}
      - BINANCE_FUTURES_BASE=${BINANCE_FUTURES_BASE:-https://fapi.binance.com}
      - DEMO_SPOT_BASE=${DEMO_SPOT_BASE}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - TRADE_SYMBOLS=*
      - BINANCE_API_TIMEOUT=15
      - BINANCE_RECV_WINDOW=60000
      - ENGINE_PORT=8003
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "9103:8003"
    networks:
      - trading_net
    command: >
      /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 256

  engine_binance:
    <<: *engine_common
    container_name: hmm_engine_binance
    env_file: .env
    environment:
      - ROLE=trader
      - VENUE=BINANCE
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - BINANCE_MODE=${BINANCE_MODE}
      - BINANCE_SPOT_BASE=${BINANCE_SPOT_BASE}
      - BINANCE_FUTURES_BASE=${BINANCE_FUTURES_BASE:-https://fapi.binance.com}  # Explicitly set for futures
      - DEMO_SPOT_BASE=${DEMO_SPOT_BASE}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - TRADE_SYMBOLS=*      # âœ… Allow ALL symbols dynamically
      - BINANCE_API_TIMEOUT=15       # more tolerant to slow networks
      - BINANCE_RECV_WINDOW=60000    # tolerant to clock skew
      - ENGINE_PORT=8003
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "8003:8003"
    networks:
      - trading_net
    command: >
      /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 1024
    healthcheck:
      # More lenient healthcheck to debug the timeout issue
      test: ["CMD", "sh", "-lc", "curl -fsS --max-time 10 http://localhost:8003/health >/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  engine_kraken_exporter:
    <<: *engine_common
    container_name: hmm_engine_kraken_exporter
    env_file: .env
    environment:
      - ROLE=exporter
      - VENUE=KRAKEN
      - TRADING_ENABLED=false
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - KRAKEN_MODE=${KRAKEN_MODE:-testnet}
      - KRAKEN_BASE_URL=${KRAKEN_BASE_URL:-https://demo-futures.kraken.com}
      - KRAKEN_API_KEY=${KRAKEN_API_KEY}
      - KRAKEN_API_SECRET=${KRAKEN_API_SECRET}
      - KRAKEN_WS_URL=${KRAKEN_WS_URL:-wss://demo-futures.kraken.com/ws/v1}
      - KRAKEN_API_TIMEOUT=${KRAKEN_API_TIMEOUT:-10}
      - TRADE_SYMBOLS=${KRAKEN_TRADED_SYMBOLS:-PI_XBTUSD.KRAKEN,PI_ETHUSD.KRAKEN}
      - QUOTE_CCY=USD
      - ENGINE_PORT=8003
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "9105:8003"
    depends_on:
      - engine_kraken
    networks:
      - trading_net
    command: >
      /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 256

  engine_kraken:
    <<: *engine_common
    container_name: hmm_engine_kraken
    env_file: .env
    environment:
      - ROLE=trader
      - VENUE=KRAKEN
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - KRAKEN_MODE=${KRAKEN_MODE:-testnet}
      - KRAKEN_BASE_URL=${KRAKEN_BASE_URL:-https://demo-futures.kraken.com}
      - KRAKEN_API_KEY=${KRAKEN_API_KEY}
      - KRAKEN_API_SECRET=${KRAKEN_API_SECRET}
      - KRAKEN_WS_URL=${KRAKEN_WS_URL:-wss://demo-futures.kraken.com/ws/v1}
      - KRAKEN_API_TIMEOUT=${KRAKEN_API_TIMEOUT:-10}
      - TRADE_SYMBOLS=${KRAKEN_TRADED_SYMBOLS:-PI_XBTUSD.KRAKEN,PI_ETHUSD.KRAKEN}
      - QUOTE_CCY=USD
      - ENGINE_PORT=8003
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "8006:8003"
    networks:
      - trading_net
    command: >
      /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 512
    healthcheck:
      test: ["CMD", "sh", "-lc", "curl -fsS --max-time 10 http://localhost:8003/health >/dev/null"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  engine_ibkr:
    <<: *engine_common
    container_name: hmm_engine_ibkr
    env_file: .env
    environment:
      - VENUE=IBKR
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - ENGINE_PORT=8003
      - TRADING_ENABLED=${TRADING_ENABLED}
      - IBKR_HOST=${IBKR_HOST}
      - IBKR_PORT=${IBKR_PORT}
      - IBKR_CLIENT_ID=${IBKR_CLIENT_ID}
      - IBKR_FEE_MODE=${IBKR_FEE_MODE}
      - IBKR_FEE_PER_SHARE=${IBKR_FEE_PER_SHARE}
      - IBKR_MIN_TRADE_FEE_USD=${IBKR_MIN_TRADE_FEE_USD}
      - IBKR_MIN_NOTIONAL_USD=${IBKR_MIN_NOTIONAL_USD}
      - BINANCE_API_TIMEOUT=15
      - BINANCE_RECV_WINDOW=60000
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "8005:8003"
    networks:
      - trading_net
    command: >
      /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1 --timeout-keep-alive 10 --limit-concurrency 256


  engine_bybit:
    <<: *engine_common
    container_name: hmm_engine_bybit
    env_file:
      - .env
      - ops/env.bybit
    environment:
      - VENUE=BYBIT
      - GOVERNANCE_POLICY=/app/engine/policies.yaml
      - ENGINE_PORT=8003
      - BINANCE_API_TIMEOUT=15
      - BINANCE_RECV_WINDOW=60000
    volumes:
      - ./engine/state:/app/engine/state:rw
      - ./engine/logs:/app/engine/logs:rw
      - ./data:/app/data:rw
    ports:
      - "8004:8003"
      - "9104:9104"

# Legacy single-engine service for backward compatibility (commented out)
# engine:
#   <<: *engine_common
#   container_name: hmm_engine
#   command: >
#     /usr/bin/tini -- uvicorn engine.app:app --host 0.0.0.0 --port 8003 --workers 1
#   environment:
#     <<: *env_common
#     BINANCE_MODE: ${BINANCE_MODE:-demo}
#     BINANCE_API_KEY: ${DEMO_API_KEY_SPOT}
#     BINANCE_API_SECRET: ${DEMO_API_SECRET_SPOT}
#     DEMO_SPOT_BASE: ${DEMO_SPOT_BASE}
#     DEMO_USDM_BASE: ${DEMO_USDM_BASE}
#     DEMO_COINM_BASE: ${DEMO_COINM_BASE}
#     BINANCE_SPOT_BASE: ${BINANCE_SPOT_BASE}
#     BINANCE_RECV_WINDOW: ${BINANCE_RECV_WINDOW}
#     BINANCE_API_TIMEOUT: ${BINANCE_API_TIMEOUT}
#     ENGINE_PORT: 8003
#   ports:
#     - "8003:8003"
#     - "9103:9103"

  ops:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_ops
    command: >
      /usr/bin/tini -- uvicorn ops.ops_api:APP
      --host 0.0.0.0 --port 8002 --workers ${OPS_WORKERS:-2}
    environment:
      <<: *env_common
      OPS_BASE: "http://ops:8002"
      DASH_BASE: "http://ops:8002"
      # Optional: point API to on-disk data (mounted below)
      OPS_DATA_DIR: /app/data
      # LIVE-3: Environment variables for live metrics
      OPS_API_TOKEN: "dev-token"  # Set to actual token for production

      ENGINE_BASE: "http://engine_binance:8003"
      ENGINE_ENDPOINTS: "${ENGINE_ENDPOINTS}"

      OPS_METRICS_PORT: "${OPS_METRICS_PORT:-9102}"

      # --- Binance mode & creds ---
      BINANCE_MODE: ${BINANCE_MODE}
      BINANCE_API_KEY: ${BINANCE_API_KEY}
      BINANCE_API_SECRET: ${BINANCE_API_SECRET}
      BINANCE_SPOT_BASE: ${BINANCE_SPOT_BASE}
      BINANCE_USDM_BASE: ${DEMO_USDM_BASE}
      BINANCE_COINM_BASE: ${DEMO_COINM_BASE}
      # http settings
      BINANCE_RECV_WINDOW: ${BINANCE_RECV_WINDOW}
      BINANCE_API_TIMEOUT: ${BINANCE_API_TIMEOUT}
    volumes:
      - ./data:/app/data:rw
    ports:
      - "${OPS_PORT:-8002}:8002"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8002/readyz | grep -q '\"ok\":true'"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      engine_binance:
        condition: service_healthy
      engine_ibkr:
        condition: service_healthy
      engine_bybit:
        condition: service_healthy

  universe:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_universe
    command: >
      /usr/bin/tini -- uvicorn universe.service:APP --host 0.0.0.0 --port 8009
    ports:
      - "8009:8009"

  situations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_situations
    command: >
      /usr/bin/tini -- uvicorn situations.service:APP --host 0.0.0.0 --port 8011
    ports:
      - "8011:8011"

  screener:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hmm_screener
    command: >
      /usr/bin/tini -- uvicorn screener.service:APP --host 0.0.0.0 --port 8010
    ports:
      - "8010:8010"
    depends_on:
      - universe
      - situations

  executor:
    build:
      context: .
      dockerfile: ops/Dockerfile
    container_name: hmm_executor
    command: python -u ops/main.py trade
    environment:
      - ENGINE_URL=http://engine_binance:8003
      - ENABLE_EXECUTION=true
      - EXEC_METRICS_PORT=9102
      - PYTHONPATH=/app
      # Trading loop config
      - EXEC_INTERVAL_SEC=2
      - TRADE_SYMBOLS=BTCUSDT,ETHUSDT,BNBUSDT
      - DRY_RUN=false
      # Dynamic sizing defaults
      - BASE_SIZE_USD=30
      - ATRP_REF=0.004
      - BETA_CONF=1.0
      - VOL_LOOKBACK_MIN=30
      - EXPOSURE_CAP_SYMBOL_USD=300
      - EXPOSURE_CAP_TOTAL_USD=1500
      # Slippage model thresholds
      - SLIP_LIMIT_THRESH_BP=12
      - SLIP_MARKET_THRESH_BP=40
      - LIMIT_ADD_BP=4
      - MAX_SLIP_BP_HARD=120
      - IOC_MARKET_BACKOFF_SEC=300
      - ENABLE_SELLS=true
      - HOLD_SEC=240
      - TP_BP=0
      - SL_BP=0
      # New: Enhanced sizing & fallback
      - MIN_NOTIONAL_MULT=1.15
      - LIMIT_ADD_BP=6
      - IOC_TO_MARKET_ON_400=true
      # Executor symbol refresh safety (seconds)
      # (deprecated/unused; kept for compatibility)
      - PROBE_USDT=30
      - MAX_SLIP_BP=120
      - MAX_ORDERS_PER_MIN=20
      - MAX_PARALLEL_ORDERS=3
      - PROBE_COOLDOWN_SEC=90
    ports:
      - "9102:9102"
    depends_on:
      engine_binance:
        condition: service_healthy
    restart: unless-stopped

  vol_ranker:
    build:
      context: .
      dockerfile: ops/Dockerfile
    command: python -u ops/vol_ranker.py --loop --interval-sec 3600 --top-n 30 --out data/top_symbols.txt
    environment:
      - PYTHONPATH=/app
    volumes:
      - ./:/app
    depends_on:
      engine_binance:
        condition: service_healthy
    restart: unless-stopped

  backfill:
    build:
      context: .
      dockerfile: ops/scheduler.Dockerfile
    container_name: hmm_backfill
    depends_on:
      situations:
        condition: service_started
    volumes:
      - ./:/app
    working_dir: /app
    restart: unless-stopped
    environment:
      - TZ=Asia/Riyadh

  slip_trainer:
    build:
      context: .
      dockerfile: ops/Dockerfile
    container_name: hmm_slip_trainer
    command: >
      sh -c "python - <<'PY'\nfrom ops.slip_model import train_from_parquet; train_from_parquet()\nPY"
    volumes:
      - ./data:/app/data
    restart: unless-stopped

networks:
  trading_net:
    external: true
    name: nautilus_trading_network
